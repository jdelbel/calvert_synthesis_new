---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(here)
library(patchwork)
library(readxl)
library(gsw)
library(zoo)
library(broom)
library(RColorBrewer)
```

```{r}
#Upload the full 5m chemtax timeseries - processing in same way as manuscript
chem <- read_csv(here("files", "chemtax_single_2025-11-21.csv"))
```

```{r}
#Working with chemtax data to make it easy to plot

#Making the date column a date format
chem <- chem %>% 
  mutate(date = lubridate::mdy(Date)) %>% 
  select(date,
         station = Station,
         depth,
         cyan = Cyanobacteria,
         hapt = Hapto, 
         GA = `Prasinophytes-3`,
         cryp = Cryptophytes,
         dino = `Dinoflagellates-1`,
         dict = Dictyo,
         raph = Raphido,
         diat = `Diatoms-1`
         )

#Pivoting to long/tidy for plotting in ggplot
chem_c_long <- chem %>% 
  pivot_longer(c(cyan:diat), names_to = "group", values_to = "contribution")

#Calculating TChla for each sample
chem_c_tchla <- chem_c_long %>% 
  group_by(date, station, depth, group) %>% 
  summarise(contribution = mean(contribution)) %>% 
  ungroup() %>% 
  group_by(date, station, depth) %>% 
  mutate(tchla = sum(contribution)) %>% 
  ungroup() %>% 
  mutate(month = lubridate::month(date),
         year = lubridate::year(date),
    month_surv = case_when(date == "2020-11-27" ~ 12,
                                date == "2022-07-28" ~ 8,
                                date == "2020-04-30" ~ 5,
                                TRUE ~ as.numeric (month))) %>% 
  mutate(month_mid = 15) %>% 
  unite(month_date, c("year", "month_surv", "month_mid"), sep = "-") %>% 
  mutate(month_date = lubridate::ymd(month_date))

#Good to move forward
```

```{r}
#Setting plotting order phytoplankton groups

#Order phytoplankton groups roughly from smallest to largest - create order list
order_chem <- c("cyan",
                "hapt",
                "GA",
                "cryp",
                "dino",
                "dict",
                "raph",
                "diat")

#Chemtax full data - Specify order of phyto groups for figures
chem_c_tchla <- arrange(mutate(chem_c_tchla,
                                group = factor(group,
                                levels = order_chem)))
```

```{r}
#Set Color palette for plotting. Currently based on QU39 manuscript. Brewer has some good ones for R style.
# Alternative version with more distinct colors (no similar reds)
npg_distinct_colors <- c(
  "#E64B35",  # Red
  "#4DBBD5",  # Light blue  
  "#00A087",  # Teal
  "#3C5488",  # Dark blue
  "#F39B7F",  # Orange
  "#8491B4",  # Purple
  "#91D1C2",  # Light teal
  "#FFC107",  # Golden yellow (replacing second red)
  "#7E6148",  # Brown
  "#B09C85"   # Light brown
)

scale_fill_npg_distinct <- function(...) {
  ggplot2::scale_fill_manual(values = npg_distinct_colors, ...)
}

scale_color_npg_distinct <- function(...) {
  ggplot2::scale_color_manual(values = npg_distinct_colors, ...)
}
```

```{r}
# Define cutoff dates
cutoff_2020 <- as.Date("2020-02-11")
cutoff_2024 <- as.Date("2024-01-01")

# Split data into three periods
data_area_early <- chem_c_tchla %>% filter(date < cutoff_2020)
data_bar_2020 <- chem_c_tchla %>% filter(date == cutoff_2020)
data_area_mid <- chem_c_tchla %>% filter(date > cutoff_2020 & date < cutoff_2024)
data_bars_late <- chem_c_tchla %>% filter(date >= cutoff_2024)

ggplot() +
  # Area plot for pre-2020-02-11
  geom_area(data = data_area_early,
            aes(x = date, y = contribution, fill = fct_rev(group)),
            position = "stack", alpha = 0.9) +
  # Single bar for 2020-02-11
  geom_bar(data = data_bar_2020,
           aes(x = date, y = contribution, fill = fct_rev(group)),
           position = "stack", stat = "identity", width = 20) +
  # Area plot for mid period
  geom_area(data = data_area_mid,
            aes(x = date, y = contribution, fill = fct_rev(group)),
            position = "stack", alpha = 0.9) +
  # Bar plot for 2024-2025
  geom_bar(data = data_bars_late,
           aes(x = date, y = contribution, fill = fct_rev(group)),
           position = "stack", stat = "identity", width = 20) +
  facet_grid(station ~ .) +
  scale_fill_npg_distinct() +
  scale_x_date(limits = as.Date(c("2016-01-01", "2025-12-31")),
               expand = c(0, 0),
               date_breaks = "1 year", date_labels = "%Y") +
  labs(
    y = expression(paste("Phytoplankton biomass (mg ", m^{-3}, ")")),
    title = "Phytoplankton community composition"
  ) +
  theme_bw() +
  theme(
    legend.position = "right",
    legend.key.height = unit(0.6, "cm"),
    legend.key.width = unit(0.8, "cm"),
    legend.title = element_blank(),
    strip.background = element_rect(fill = "grey90"),
    strip.text = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.x = element_blank(),
    text = element_text(size = 28, color = "black")
  )

ggsave(here("figures", "phytoplankton_community_composition.png"), 
       width = 16, height = 8, dpi = 300)
```

```{r}
# Add TChla as a group in long format
chem_c_tchla_with_total <- chem_c_tchla %>%
  bind_rows(
    chem_c_tchla %>%
      distinct(date, station, depth, tchla) %>%
      mutate(group = "TChla",
             contribution = tchla)
  )

# Find dates where both stations were sampled
shared_dates <- chem_c_tchla_with_total %>%
  filter(station %in% c("KC10", "FZH01")) %>%
  group_by(date) %>%
  filter(n_distinct(station) == 2) %>%
  ungroup() %>%
  pull(date) %>%
  unique()

# Prepare data for comparison - wide format
compare_data <- chem_c_tchla_with_total %>%
  filter(date %in% shared_dates, station %in% c("KC10", "FZH01")) %>%
  group_by(date, station, group) %>%
  summarise(
    contribution = sum(contribution, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = station,
    values_from = contribution,
    names_sep = "_"
  )

# Calculate relative contribution (excluding TChla)
compare_data_rel <- compare_data %>%
  filter(group != "TChla") %>%
  group_by(date) %>%
  mutate(
    rel_FZH01 = FZH01 / sum(FZH01, na.rm = TRUE),
    rel_KC10 = KC10 / sum(KC10, na.rm = TRUE)
  ) %>%
  ungroup()

# Function to get regression stats
get_stats <- function(x, y) {
  model <- lm(y ~ x)
  r2 <- summary(model)$r.squared
  slope <- coef(model)[2]
  intercept <- coef(model)[1]
  p_val <- summary(model)$coefficients[2, 4]
  n <- sum(!is.na(x) & !is.na(y))
  sprintf("y = %.2fx + %.2f\nRÂ² = %.3f, p = %.4f\nn = %d", slope, intercept, r2, p_val, n)
}

# Stats for absolute
stats_abs <- compare_data %>%
  group_by(group) %>%
  summarise(
    label = get_stats(FZH01, KC10),
    .groups = "drop"
  )

# Stats for relative
stats_rel <- compare_data_rel %>%
  group_by(group) %>%
  summarise(
    label = get_stats(rel_FZH01, rel_KC10),
    .groups = "drop"
  )

# Panel 1: Absolute contribution (includes TChla)
p1 <- compare_data %>%
  ggplot(aes(x = FZH01, y = KC10, color = group)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey40") +
  geom_smooth(method = "lm", se = TRUE, alpha = 0.2, linewidth = 0.8) +
  geom_point(size = 3, alpha = 0.7) +
  geom_text(data = stats_abs,
            aes(x = Inf, y = -Inf, label = label),
            hjust = 1.05, vjust = -0.1,
            size = 4, fontface = "italic",
            show.legend = FALSE) +
  facet_wrap(~ group, scales = "free") +
  scale_color_npg_distinct() +
  labs(
    x = expression(paste("FZH01 (mg ", m^{-3}, ")")),
    y = expression(paste("KC10 (mg ", m^{-3}, ")")),
    title = "Absolute contribution by group"
  ) +
  theme_bw() +
  theme(
    legend.position = "none",
    strip.background = element_rect(fill = "grey90"),
    strip.text = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    text = element_text(size = 28, color = "black")
  )

# Panel 2: Relative contribution (excludes TChla)
p2 <- compare_data_rel %>%
  ggplot(aes(x = rel_FZH01, y = rel_KC10, color = group)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey40") +
  geom_smooth(method = "lm", se = TRUE, alpha = 0.2, linewidth = 0.8) +
  geom_point(size = 3, alpha = 0.7) +
  geom_text(data = stats_rel,
            aes(x = Inf, y = -Inf, label = label),
            hjust = 1.05, vjust = -0.1,
            size = 4, fontface = "italic",
            show.legend = FALSE) +
  facet_wrap(~ group, scales = "free") +
  scale_color_npg_distinct() +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = "FZH01 relative contribution",
    y = "KC10 relative contribution",
    title = "Relative contribution by group"
  ) +
  theme_bw() +
  theme(
    legend.position = "none",
    strip.background = element_rect(fill = "grey90"),
    strip.text = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    text = element_text(size = 28, color = "black")
  )

# Combine
p1 / p2

ggsave(here("figures", "station_comparison_by_group.png"), 
       width = 14, height = 18, dpi = 300)
```
```{r}
# Combine stations with daily averaging
chem_c_tchla_combined <- chem_c_tchla %>%
  group_by(date, group) %>%
  summarise(
    contribution = mean(contribution, na.rm = TRUE),
    n_stations = n_distinct(station),
    .groups = 'drop'
  )

# Define cutoff dates
cutoff_2020 <- as.Date("2020-02-11")
cutoff_2024 <- as.Date("2024-01-01")

# Split combined data into three periods
data_area_early <- chem_c_tchla_combined %>% filter(date < cutoff_2020)
data_bar_2020 <- chem_c_tchla_combined %>% filter(date == cutoff_2020)
data_area_mid <- chem_c_tchla_combined %>% filter(date > cutoff_2020 & date < cutoff_2024)
data_bars_late <- chem_c_tchla_combined %>% filter(date >= cutoff_2024)

# Create combined plot
ggplot() +
  # Area plot for pre-2020-02-11
  geom_area(data = data_area_early,
            aes(x = date, y = contribution, fill = fct_rev(group)),
            position = "stack", alpha = 0.9) +
  # Single bar for 2020-02-11
  geom_bar(data = data_bar_2020,
           aes(x = date, y = contribution, fill = fct_rev(group)),
           position = "stack", stat = "identity", width = 20) +
  # Area plot for mid period
  geom_area(data = data_area_mid,
            aes(x = date, y = contribution, fill = fct_rev(group)),
            position = "stack", alpha = 0.9) +
  # Bar plot for 2024-2025
  geom_bar(data = data_bars_late,
           aes(x = date, y = contribution, fill = fct_rev(group)),
           position = "stack", stat = "identity", width = 20) +
  scale_fill_npg_distinct() +
  scale_x_date(limits = as.Date(c("2016-01-01", "2025-12-31")),
               expand = c(0, 0),
               date_breaks = "1 year", date_labels = "%Y") +
  labs(
    y = expression(paste("Phytoplankton biomass (mg ", m^{-3}, ")")),
    # title = "Phytoplankton community composition",
    # subtitle = "Combined stations (daily averages)"
  ) +
  theme_bw() +
  theme(
    legend.position = "right",
    legend.key.height = unit(0.6, "cm"),
    legend.key.width = unit(0.8, "cm"),
    legend.title = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.x = element_blank(),
    text = element_text(size = 28, color = "black")
  )

ggsave(here("figures", "phytoplankton_community_composition_combined.png"), 
       width = 16, height = 6.5, dpi = 300)
```

```{r}
# Function to find and average consecutive/near-consecutive samples
average_consecutive_samples <- function(data, window_days = 2) {
  data %>%
    arrange(date) %>%
    mutate(
      # Create groups for dates within window_days of each other
      date_diff = c(Inf, diff(date)),
      new_group = cumsum(date_diff > window_days)
    ) %>%
    group_by(new_group, group) %>%
    summarise(
      date = mean(date),  # Use mean date for the window
      contribution = mean(contribution, na.rm = TRUE),
      n_samples = n(),
      .groups = 'drop'
    ) %>%
    select(-new_group) %>%
    mutate(date = as.Date(date, origin = "1970-01-01"))
}

# Combine stations with consecutive day averaging
chem_c_tchla_combined <- chem_c_tchla %>%
  group_by(date, group) %>%
  summarise(
    contribution = mean(contribution, na.rm = TRUE),
    n_stations = n_distinct(station),
    .groups = 'drop'
  ) %>%
  arrange(group, date) %>%
  group_by(group) %>%
  mutate(
    date_diff = c(Inf, diff(date)),
    window_group = cumsum(date_diff > 2)  # Create new group when gap > 2 days
  ) %>%
  group_by(group, window_group) %>%
  summarise(
    date = mean(date),
    contribution = mean(contribution, na.rm = TRUE),
    n_samples = n(),
    .groups = 'drop'
  ) %>%
  select(-window_group) %>%
  mutate(date = as.Date(date, origin = "1970-01-01"))

# Define cutoff dates
cutoff_2020 <- as.Date("2020-02-11")
cutoff_2024 <- as.Date("2024-01-01")

# Split combined data into three periods
data_area_early <- chem_c_tchla_combined %>% filter(date < cutoff_2020)
data_bar_2020 <- chem_c_tchla_combined %>% filter(date == cutoff_2020)
data_area_mid <- chem_c_tchla_combined %>% filter(date > cutoff_2020 & date < cutoff_2024)
data_bars_late <- chem_c_tchla_combined %>% filter(date >= cutoff_2024)

# Create combined plot
ggplot() +
  # Area plot for pre-2020-02-11
  geom_area(data = data_area_early,
            aes(x = date, y = contribution, fill = fct_rev(group)),
            position = "stack", alpha = 0.9) +
  # Single bar for 2020-02-11
  geom_bar(data = data_bar_2020,
           aes(x = date, y = contribution, fill = fct_rev(group)),
           position = "stack", stat = "identity", width = 20) +
  # Area plot for mid period
  geom_area(data = data_area_mid,
            aes(x = date, y = contribution, fill = fct_rev(group)),
            position = "stack", alpha = 0.9) +
  # Bar plot for 2024-2025
  geom_bar(data = data_bars_late,
           aes(x = date, y = contribution, fill = fct_rev(group)),
           position = "stack", stat = "identity", width = 20) +
  scale_fill_npg_distinct() +
  scale_x_date(limits = as.Date(c("2016-01-01", "2025-12-31")),
               expand = c(0, 0),
               date_breaks = "1 year", date_labels = "%Y") +
  labs(
    y = expression(paste("Phytoplankton biomass (mg ", m^{-3}, ")")),
  ) +
  theme_bw() +
  theme(
    legend.position = "right",
    legend.key.height = unit(0.6, "cm"),
    legend.key.width = unit(0.8, "cm"),
    legend.title = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.x = element_blank(),
    text = element_text(size = 28, color = "black")
  )

ggsave(here("figures", "phytoplankton_community_composition_combined_2day.png"), 
       width = 16, height = 6.5, dpi = 300)
```



```{r}
# Calculate monthly climatology from combined data
chem_climatology <- chem_c_tchla_combined %>%
  mutate(month = month(date)) %>%
  group_by(month, group) %>%
  summarise(
    contribution_mean = mean(contribution, na.rm = TRUE),
    contribution_sd = sd(contribution, na.rm = TRUE),
    n_years = n_distinct(year(date)),
    .groups = 'drop'
  ) %>%
  # Create a date for plotting (using 2020 as dummy year)
  mutate(date_plot = as.Date(paste("2020", month, "15", sep = "-")))

# Create climatology bar plot
ggplot(chem_climatology, aes(x = date_plot, y = contribution_mean, fill = fct_rev(group))) +
  geom_bar(position = "stack", stat = "identity", width = 25) +
  scale_fill_npg_distinct() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b",
               expand = c(0.02, 0)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 6)) +
  labs(
    y = expression(paste("Phytoplankton biomass (mg ", m^{-3}, ")")),
    title = "Phytoplankton community composition - Monthly climatology",
    subtitle = paste("Based on", 
                     min(chem_climatology$n_years), "-", 
                     max(chem_climatology$n_years), "years of data per month")
  ) +
  theme_bw() +
  theme(
    legend.position = "right",
    legend.key.height = unit(0.6, "cm"),
    legend.key.width = unit(0.8, "cm"),
    legend.title = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.x = element_blank(),
    text = element_text(size = 28, color = "black")
  )

ggsave(here("figures", "phytoplankton_climatology_monthly.png"), 
       width = 16, height = 7, dpi = 300)
```

```{r}
# Calculate monthly anomalies with monthly aggregation
chem_anomalies_monthly <- chem_c_tchla_combined %>%
  mutate(
    year = year(date),
    month = month(date),
    year_month = floor_date(date, "month")
  ) %>%
  # First aggregate to monthly means
  group_by(year_month, month, group) %>%
  summarise(
    contribution_monthly = mean(contribution, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  # Join with climatology
  left_join(
    chem_climatology %>% select(month, group, contribution_mean),
    by = c("month", "group")
  ) %>%
  # Calculate anomaly and classify as positive/negative
  mutate(
    anomaly = contribution_monthly - contribution_mean,
    anomaly_type = if_else(anomaly >= 0, "Positive", "Negative")
  )

# Plot faceted anomalies
ggplot(chem_anomalies_monthly, aes(x = year_month, y = anomaly, fill = anomaly_type)) +
  geom_hline(yintercept = 0, color = "black", linewidth = 0.5) +
  geom_bar(stat = "identity", width = 25) +
  facet_wrap(~ group, ncol = 1, scales = "free_y", strip.position = "right") +
  scale_fill_manual(
    values = c("Positive" = "#D32F2F", "Negative" = "#1976D2"),
    guide = "none"
  ) +
  scale_x_date(limits = as.Date(c("2016-01-01", "2025-12-31")),
               expand = c(0, 0),
               date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(expand = c(0.02, 0), labels = scales::number_format(accuracy = 0.01)) +
  labs(
    y = expression(paste("Biomass anomaly (mg ", m^{-3}, ")")),
  ) +
  theme_bw() +
  theme(
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold", size = 28, color = "black", angle = 270),
    strip.placement = "outside",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.spacing = unit(2, "lines"),  # Add gap between facets
    axis.title.x = element_blank(),
    axis.title.y = element_text(size = 28, color = "black"),
    axis.text = element_text(size = 28, color = "black"),
  )

ggsave(here("figures", "phytoplankton_anomalies_faceted.png"), 
       width = 16, height = 16, dpi = 300)
```

```{r}
library(vegan)
library(patchwork)

# Prepare data - create sample IDs and add year
chem_nmds_data <- chem_c_tchla %>%
  mutate(
    sample_id = paste(date, station, sep = "_"),  # Create unique sample ID
    year = year(date)
  )

# Create absolute abundance matrix
nmds_matrix_abs <- chem_nmds_data %>%
  select(sample_id, group, contribution) %>%
  pivot_wider(names_from = group, values_from = contribution, values_fill = 0) %>%
  column_to_rownames("sample_id")

# Create relative abundance matrix
nmds_matrix_rel <- chem_nmds_data %>%
  group_by(sample_id) %>%
  mutate(rel_contribution = contribution / sum(contribution) * 100) %>%
  ungroup() %>%
  select(sample_id, group, rel_contribution) %>%
  pivot_wider(names_from = group, values_from = rel_contribution, values_fill = 0) %>%
  column_to_rownames("sample_id")

# Apply square root transformation
nmds_matrix_abs_sqrt <- sqrt(nmds_matrix_abs)
nmds_matrix_rel_sqrt <- sqrt(nmds_matrix_rel)

# Run NMDS with transformed data
nmds_abs <- metaMDS(nmds_matrix_abs_sqrt, distance = "bray", k = 2, trymax = 100)
nmds_rel <- metaMDS(nmds_matrix_rel_sqrt, distance = "bray", k = 2, trymax = 100)

# Extract scores and add year
metadata <- chem_nmds_data %>%
  distinct(sample_id, year)

nmds_abs_scores <- scores(nmds_abs, display = "sites") %>%
  as.data.frame() %>%
  rownames_to_column("sample_id") %>%
  left_join(metadata, by = "sample_id")

nmds_rel_scores <- scores(nmds_rel, display = "sites") %>%
  as.data.frame() %>%
  rownames_to_column("sample_id") %>%
  left_join(metadata, by = "sample_id")

# Get stress values
stress_abs <- round(nmds_abs$stress, 3)
stress_rel <- round(nmds_rel$stress, 3)

# Create absolute abundance plot
p1 <- ggplot(nmds_abs_scores, aes(x = NMDS1, y = NMDS2, color = factor(year))) +
  geom_point(size = 4, alpha = 0.7) +
  annotate("text", x = Inf, y = Inf, 
           label = paste("Stress =", stress_abs),
           hjust = 1.1, vjust = 1.5, size = 6, fontface = "bold") +
  scale_color_viridis_d(name = "Year") +
  labs(title = "A) Absolute abundance (sqrt transformed)") +
  theme_bw(base_size = 28) +
  theme(
    legend.position = "none",
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black")
  )

# Create relative abundance plot
p2 <- ggplot(nmds_rel_scores, aes(x = NMDS1, y = NMDS2, color = factor(year))) +
  geom_point(size = 4, alpha = 0.7) +
  annotate("text", x = Inf, y = Inf, 
           label = paste("Stress =", stress_rel),
           hjust = 1.1, vjust = 1.5, size = 6, fontface = "bold") +
  scale_color_viridis_d(name = "Year") +
  labs(title = "B) Relative abundance (sqrt transformed)") +
  theme_bw(base_size = 28) +
  theme(
    legend.position = "right",
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    legend.title = element_text(size = 24, face = "bold"),
    legend.text = element_text(size = 20)
  )

# Combine plots
combined_plot <- p1 + p2 + plot_layout(widths = c(1, 1.3))

ggsave(here("figures", "nmds_panel_absolute_relative_sqrt.png"),
       plot = combined_plot,
       width = 20, height = 8, dpi = 300)

# Print stress values
cat("Absolute abundance stress (sqrt):", stress_abs, "\n")
cat("Relative abundance stress (sqrt):", stress_rel, "\n")
```

```{r}
library(vegan)

# Try multiple transformations
transforms <- list(
  "None" = nmds_matrix_abs,
  "Square root" = sqrt(nmds_matrix_abs),
  "Fourth root" = nmds_matrix_abs^0.25,
  "Log(x+1)" = log1p(nmds_matrix_abs),
  "Wisconsin" = wisconsin(nmds_matrix_abs)
)

# Run NMDS on each
nmds_results <- map(transforms, ~metaMDS(.x, distance = "bray", k = 2, trymax = 100))

# Compare stress values
stress_comparison <- tibble(
  transformation = names(nmds_results),
  stress = map_dbl(nmds_results, ~.x$stress)
) %>%
  arrange(stress)

print(stress_comparison)

# Plot the best one
best_transform <- stress_comparison$transformation[1]
cat("\nBest transformation:", best_transform, "with stress =", stress_comparison$stress[1], "\n")
```
```{r}
library(vegan)
library(ape)
library(patchwork)

# Prepare data - create sample IDs and add year
chem_nmds_data <- chem_c_tchla %>%
  mutate(
    sample_id = paste(date, station, sep = "_"),  # Create unique sample ID
    year = year(date)
  )

# Create absolute abundance matrix
nmds_matrix_abs <- chem_nmds_data %>%
  select(sample_id, group, contribution) %>%
  pivot_wider(names_from = group, values_from = contribution, values_fill = 0) %>%
  column_to_rownames("sample_id")

# Create relative abundance matrix
nmds_matrix_rel <- chem_nmds_data %>%
  group_by(sample_id) %>%
  mutate(rel_contribution = contribution / sum(contribution) * 100) %>%
  ungroup() %>%
  select(sample_id, group, rel_contribution) %>%
  pivot_wider(names_from = group, values_from = rel_contribution, values_fill = 0) %>%
  column_to_rownames("sample_id")

# Apply square root transformation
nmds_matrix_abs_sqrt <- sqrt(nmds_matrix_abs)
nmds_matrix_rel_sqrt <- sqrt(nmds_matrix_rel)

# Calculate Bray-Curtis distances
dist_abs <- vegdist(nmds_matrix_abs_sqrt, method = "bray")
dist_rel <- vegdist(nmds_matrix_rel_sqrt, method = "bray")

# Run PCoA
pcoa_abs <- pcoa(dist_abs)
pcoa_rel <- pcoa(dist_rel)

# Extract % variation explained
var_abs <- round(pcoa_abs$values$Relative_eig[1:2] * 100, 1)
var_rel <- round(pcoa_rel$values$Relative_eig[1:2] * 100, 1)

# Extract scores and add metadata
metadata <- chem_nmds_data %>%
  distinct(sample_id, year)

pcoa_abs_scores <- pcoa_abs$vectors[, 1:2] %>%
  as.data.frame() %>%
  rownames_to_column("sample_id") %>%
  left_join(metadata, by = "sample_id")

pcoa_rel_scores <- pcoa_rel$vectors[, 1:2] %>%
  as.data.frame() %>%
  rownames_to_column("sample_id") %>%
  left_join(metadata, by = "sample_id")

# Create absolute abundance plot
p1 <- ggplot(pcoa_abs_scores, aes(x = Axis.1, y = Axis.2, color = factor(year))) +
  geom_point(size = 4, alpha = 0.7) +
  annotate("text", x = Inf, y = Inf, 
           label = paste0("Var explained:\nAxis 1: ", var_abs[1], "%\nAxis 2: ", var_abs[2], "%"),
           hjust = 1.1, vjust = 1.1, size = 5, fontface = "bold") +
  scale_color_viridis_d(name = "Year") +
  labs(
    title = "A) Absolute abundance (sqrt transformed)",
    x = paste0("PCoA 1 (", var_abs[1], "%)"),
    y = paste0("PCoA 2 (", var_abs[2], "%)")
  ) +
  theme_bw(base_size = 28) +
  theme(
    legend.position = "none",
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black")
  )

# Create relative abundance plot
p2 <- ggplot(pcoa_rel_scores, aes(x = Axis.1, y = Axis.2, color = factor(year))) +
  geom_point(size = 4, alpha = 0.7) +
  annotate("text", x = Inf, y = Inf, 
           label = paste0("Var explained:\nAxis 1: ", var_rel[1], "%\nAxis 2: ", var_rel[2], "%"),
           hjust = 1.1, vjust = 1.1, size = 5, fontface = "bold") +
  scale_color_viridis_d(name = "Year") +
  labs(
    title = "B) Relative abundance (sqrt transformed)",
    x = paste0("PCoA 1 (", var_rel[1], "%)"),
    y = paste0("PCoA 2 (", var_rel[2], "%)")
  ) +
  theme_bw(base_size = 28) +
  theme(
    legend.position = "right",
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    legend.title = element_text(size = 24, face = "bold"),
    legend.text = element_text(size = 20)
  )

# Combine plots
combined_plot <- p1 + p2 + plot_layout(widths = c(1, 1.3))

ggsave(here("figures", "pcoa_panel_absolute_relative_sqrt.png"),
       plot = combined_plot,
       width = 20, height = 8, dpi = 300)

# Print variance explained
cat("Absolute abundance - Axis 1:", var_abs[1], "%, Axis 2:", var_abs[2], "%\n")
cat("Relative abundance - Axis 1:", var_rel[1], "%, Axis 2:", var_rel[2], "%\n")
cat("Total variance (first 2 axes):\n")
cat("  Absolute:", sum(var_abs), "%\n")
cat("  Relative:", sum(var_rel), "%\n")
```



