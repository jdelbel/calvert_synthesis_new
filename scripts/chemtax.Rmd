---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(here)
library(patchwork)
library(readxl)
library(gsw)
library(zoo)
library(broom)
library(RColorBrewer)
```

```{r}
#Upload the full 5m chemtax timeseries - processing in same way as manuscript
chem <- read_csv(here("files", "chemtax_single_2025-12-01.csv"))
```

```{r}
#Working with chemtax data to make it easy to plot

#Making the date column a date format
chem <- chem %>% 
  mutate(date = lubridate::mdy(Date)) %>% 
  select(date,
         station = Station,
         depth,
         cyan = Cyanobacteria,
         hapt = Hapto, 
         GA = `Prasinophytes-3`,
         cryp = Cryptophytes,
         dino = `Dinoflagellates-1`,
         dict = Dictyo,
         raph = Raphido,
         diat = `Diatoms-1`
         )

#Pivoting to long/tidy for plotting in ggplot
chem_c_long <- chem %>% 
  pivot_longer(c(cyan:diat), names_to = "group", values_to = "contribution")

#Calculating TChla for each sample
chem_c_tchla <- chem_c_long %>% 
  group_by(date, station, depth, group) %>% 
  summarise(contribution = mean(contribution)) %>% 
  ungroup() %>% 
  group_by(date, station, depth) %>% 
  mutate(tchla = sum(contribution)) %>% 
  ungroup() %>% 
  mutate(month = lubridate::month(date),
         year = lubridate::year(date),
    month_surv = case_when(date == "2020-11-27" ~ 12,
                                date == "2022-07-28" ~ 8,
                                date == "2020-04-30" ~ 5,
                                TRUE ~ as.numeric (month))) %>% 
  mutate(month_mid = 15) %>% 
  unite(month_date, c("year", "month_surv", "month_mid"), sep = "-") %>% 
  mutate(month_date = lubridate::ymd(month_date))

#Good to move forward
```

```{r}
#Setting plotting order phytoplankton groups

#Order phytoplankton groups roughly from smallest to largest - create order list
order_chem <- c("cyan",
                "hapt",
                "GA",
                "cryp",
                "dino",
                "dict",
                "raph",
                "diat")

#Chemtax full data - Specify order of phyto groups for figures
chem_c_tchla <- arrange(mutate(chem_c_tchla,
                                group = factor(group,
                                levels = order_chem)))
```

```{r}
#Set Color palette for plotting. Currently based on QU39 manuscript. Brewer has some good ones for R style.
# Alternative version with more distinct colors (no similar reds)
npg_distinct_colors <- c(
  "#E64B35",  # Red
  "#4DBBD5",  # Light blue  
  "#00A087",  # Teal
  "#3C5488",  # Dark blue
  "#F39B7F",  # Orange
  "#8491B4",  # Purple
  "#91D1C2",  # Light teal
  "#FFC107",  # Golden yellow (replacing second red)
  "#7E6148",  # Brown
  "#B09C85"   # Light brown
)

scale_fill_npg_distinct <- function(...) {
  ggplot2::scale_fill_manual(values = npg_distinct_colors, ...)
}

scale_color_npg_distinct <- function(...) {
  ggplot2::scale_color_manual(values = npg_distinct_colors, ...)
}
```

```{r}
# Define cutoff dates
cutoff_2020 <- as.Date("2020-02-11")
cutoff_2024 <- as.Date("2024-01-01")

# Split data into three periods
data_area_early <- chem_c_tchla %>% filter(date < cutoff_2020)
data_bar_2020 <- chem_c_tchla %>% filter(date == cutoff_2020)
data_area_mid <- chem_c_tchla %>% filter(date > cutoff_2020 & date < cutoff_2024)
data_bars_late <- chem_c_tchla %>% filter(date >= cutoff_2024)

ggplot() +
  # Area plot for pre-2020-02-11
  geom_area(data = data_area_early,
            aes(x = date, y = contribution, fill = fct_rev(group)),
            position = "stack", alpha = 0.9) +
  # Single bar for 2020-02-11
  geom_bar(data = data_bar_2020,
           aes(x = date, y = contribution, fill = fct_rev(group)),
           position = "stack", stat = "identity", width = 20) +
  # Area plot for mid period
  geom_area(data = data_area_mid,
            aes(x = date, y = contribution, fill = fct_rev(group)),
            position = "stack", alpha = 0.9) +
  # Bar plot for 2024-2025
  geom_bar(data = data_bars_late,
           aes(x = date, y = contribution, fill = fct_rev(group)),
           position = "stack", stat = "identity", width = 20) +
  facet_grid(station ~ .) +
  scale_fill_npg_distinct() +
  scale_x_date(limits = as.Date(c("2016-01-01", "2025-12-31")),
               expand = c(0, 0),
               date_breaks = "1 year", date_labels = "%Y") +
  labs(
    y = expression(paste("Phytoplankton biomass (mg ", m^{-3}, ")")),
    title = "Phytoplankton community composition"
  ) +
  theme_bw() +
  theme(
    legend.position = "right",
    legend.key.height = unit(0.6, "cm"),
    legend.key.width = unit(0.8, "cm"),
    legend.title = element_blank(),
    strip.background = element_rect(fill = "grey90"),
    strip.text = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.x = element_blank(),
    text = element_text(size = 28, color = "black")
  )

ggsave(here("figures", "phytoplankton_community_composition.png"), 
       width = 16, height = 8, dpi = 300)
```

```{r}
# Add TChla as a group in long format
chem_c_tchla_with_total <- chem_c_tchla %>%
  bind_rows(
    chem_c_tchla %>%
      distinct(date, station, depth, tchla) %>%
      mutate(group = "TChla",
             contribution = tchla)
  )

# Find dates where both stations were sampled
shared_dates <- chem_c_tchla_with_total %>%
  filter(station %in% c("KC10", "FZH01")) %>%
  group_by(date) %>%
  filter(n_distinct(station) == 2) %>%
  ungroup() %>%
  pull(date) %>%
  unique()

# Prepare data for comparison - wide format
compare_data <- chem_c_tchla_with_total %>%
  filter(date %in% shared_dates, station %in% c("KC10", "FZH01")) %>%
  group_by(date, station, group) %>%
  summarise(
    contribution = sum(contribution, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = station,
    values_from = contribution,
    names_sep = "_"
  )

# Calculate relative contribution (excluding TChla)
compare_data_rel <- compare_data %>%
  filter(group != "TChla") %>%
  group_by(date) %>%
  mutate(
    rel_FZH01 = FZH01 / sum(FZH01, na.rm = TRUE),
    rel_KC10 = KC10 / sum(KC10, na.rm = TRUE)
  ) %>%
  ungroup()

# Function to get regression stats
get_stats <- function(x, y) {
  model <- lm(y ~ x)
  r2 <- summary(model)$r.squared
  slope <- coef(model)[2]
  intercept <- coef(model)[1]
  p_val <- summary(model)$coefficients[2, 4]
  n <- sum(!is.na(x) & !is.na(y))
  sprintf("y = %.2fx + %.2f\nRÂ² = %.3f, p = %.4f\nn = %d", slope, intercept, r2, p_val, n)
}

# Stats for absolute
stats_abs <- compare_data %>%
  group_by(group) %>%
  summarise(
    label = get_stats(FZH01, KC10),
    .groups = "drop"
  )

# Stats for relative
stats_rel <- compare_data_rel %>%
  group_by(group) %>%
  summarise(
    label = get_stats(rel_FZH01, rel_KC10),
    .groups = "drop"
  )

# Panel 1: Absolute contribution (includes TChla)
p1 <- compare_data %>%
  ggplot(aes(x = FZH01, y = KC10, color = group)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey40") +
  geom_smooth(method = "lm", se = TRUE, alpha = 0.2, linewidth = 0.8) +
  geom_point(size = 3, alpha = 0.7) +
  geom_text(data = stats_abs,
            aes(x = Inf, y = -Inf, label = label),
            hjust = 1.05, vjust = -0.1,
            size = 4, fontface = "italic",
            show.legend = FALSE) +
  facet_wrap(~ group, scales = "free") +
  scale_color_npg_distinct() +
  labs(
    x = expression(paste("FZH01 (mg ", m^{-3}, ")")),
    y = expression(paste("KC10 (mg ", m^{-3}, ")")),
    title = "Absolute contribution by group"
  ) +
  theme_bw() +
  theme(
    legend.position = "none",
    strip.background = element_rect(fill = "grey90"),
    strip.text = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    text = element_text(size = 28, color = "black")
  )

# Panel 2: Relative contribution (excludes TChla)
p2 <- compare_data_rel %>%
  ggplot(aes(x = rel_FZH01, y = rel_KC10, color = group)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey40") +
  geom_smooth(method = "lm", se = TRUE, alpha = 0.2, linewidth = 0.8) +
  geom_point(size = 3, alpha = 0.7) +
  geom_text(data = stats_rel,
            aes(x = Inf, y = -Inf, label = label),
            hjust = 1.05, vjust = -0.1,
            size = 4, fontface = "italic",
            show.legend = FALSE) +
  facet_wrap(~ group, scales = "free") +
  scale_color_npg_distinct() +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = "FZH01 relative contribution",
    y = "KC10 relative contribution",
    title = "Relative contribution by group"
  ) +
  theme_bw() +
  theme(
    legend.position = "none",
    strip.background = element_rect(fill = "grey90"),
    strip.text = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    text = element_text(size = 28, color = "black")
  )

# Combine
p1 / p2

ggsave(here("figures", "station_comparison_by_group.png"), 
       width = 14, height = 18, dpi = 300)
```
```{r}
# Function to find and average consecutive/near-consecutive samples
average_consecutive_samples <- function(data, window_days = 2) {
  data %>%
    arrange(date) %>%
    mutate(
      # Create groups for dates within window_days of each other
      date_diff = c(Inf, diff(date)),
      new_group = cumsum(date_diff > window_days)
    ) %>%
    group_by(new_group, group) %>%
    summarise(
      date = mean(date),  # Use mean date for the window
      contribution = mean(contribution, na.rm = TRUE),
      n_samples = n(),
      .groups = 'drop'
    ) %>%
    select(-new_group) %>%
    mutate(date = as.Date(date, origin = "1970-01-01"))
}

# Combine stations with consecutive day averaging
chem_c_tchla_combined <- chem_c_tchla %>%
  group_by(date, group) %>%
  summarise(
    contribution = mean(contribution, na.rm = TRUE),
    n_stations = n_distinct(station),
    .groups = 'drop'
  ) %>%
  arrange(group, date) %>%
  group_by(group) %>%
  mutate(
    date_diff = c(Inf, diff(date)),
    window_group = cumsum(date_diff > 2)  # Create new group when gap > 2 days
  ) %>%
  group_by(group, window_group) %>%
  summarise(
    date = mean(date),
    contribution = mean(contribution, na.rm = TRUE),
    n_samples = n(),
    .groups = 'drop'
  ) %>%
  select(-window_group) %>%
  mutate(date = as.Date(date, origin = "1970-01-01"))

# Define cutoff dates
cutoff_2020 <- as.Date("2020-02-11")
cutoff_2024 <- as.Date("2024-01-01")

# Split combined data into three periods
data_area_early <- chem_c_tchla_combined %>% filter(date < cutoff_2020)
data_bar_2020 <- chem_c_tchla_combined %>% filter(date == cutoff_2020)
data_area_mid <- chem_c_tchla_combined %>% filter(date > cutoff_2020 & date < cutoff_2024)
data_bars_late <- chem_c_tchla_combined %>% filter(date >= cutoff_2024)

# Create combined plot
ggplot() +
  # Area plot for pre-2020-02-11
  geom_area(data = data_area_early,
            aes(x = date, y = contribution, fill = fct_rev(group)),
            position = "stack", alpha = 0.9) +
  # Single bar for 2020-02-11
  geom_bar(data = data_bar_2020,
           aes(x = date, y = contribution, fill = fct_rev(group)),
           position = "stack", stat = "identity", width = 20) +
  # Area plot for mid period
  geom_area(data = data_area_mid,
            aes(x = date, y = contribution, fill = fct_rev(group)),
            position = "stack", alpha = 0.9) +
  # Bar plot for 2024-2025
  geom_bar(data = data_bars_late,
           aes(x = date, y = contribution, fill = fct_rev(group)),
           position = "stack", stat = "identity", width = 20) +
  scale_fill_npg_distinct() +
  scale_x_date(limits = as.Date(c("2016-01-01", "2025-12-31")),
               expand = c(0, 0),
               date_breaks = "1 year", date_labels = "%Y") +
  labs(
    y = expression(paste("Phytoplankton biomass (mg ", m^{-3}, ")")),
  ) +
  theme_bw() +
  theme(
    legend.position = "right",
    legend.key.height = unit(0.6, "cm"),
    legend.key.width = unit(0.8, "cm"),
    legend.title = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.x = element_blank(),
    text = element_text(size = 28, color = "black")
  )

ggsave(here("figures", "phytoplankton_community_composition_combined_2day.png"), 
       width = 16, height = 6.5, dpi = 300)
```



```{r}
# Calculate monthly climatology from combined data
chem_climatology <- chem_c_tchla_combined %>%
  mutate(month = month(date)) %>%
  group_by(month, group) %>%
  summarise(
    contribution_mean = mean(contribution, na.rm = TRUE),
    contribution_sd = sd(contribution, na.rm = TRUE),
    n_years = n_distinct(year(date)),
    .groups = 'drop'
  ) %>%
  # Create a date for plotting (using 2020 as dummy year)
  mutate(date_plot = as.Date(paste("2020", month, "15", sep = "-")))

# Create climatology bar plot
ggplot(chem_climatology, aes(x = date_plot, y = contribution_mean, fill = fct_rev(group))) +
  geom_bar(position = "stack", stat = "identity", width = 25) +
  scale_fill_npg_distinct() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b",
               expand = c(0.02, 0)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 6)) +
  labs(
    y = expression(paste("Phytoplankton biomass (mg ", m^{-3}, ")")),
    title = "Phytoplankton community composition - Monthly climatology",
    subtitle = paste("Based on", 
                     min(chem_climatology$n_years), "-", 
                     max(chem_climatology$n_years), "years of data per month")
  ) +
  theme_bw() +
  theme(
    legend.position = "right",
    legend.key.height = unit(0.6, "cm"),
    legend.key.width = unit(0.8, "cm"),
    legend.title = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.x = element_blank(),
    text = element_text(size = 28, color = "black")
  )

ggsave(here("figures", "phytoplankton_climatology_monthly.png"), 
       width = 16, height = 7, dpi = 300)
```

```{r}
# Calculate monthly anomalies with monthly aggregation
chem_anomalies_monthly <- chem_c_tchla_combined %>%
  mutate(
    year = year(date),
    month = month(date),
    year_month = floor_date(date, "month")
  ) %>%
  # First aggregate to monthly means
  group_by(year_month, month, group) %>%
  summarise(
    contribution_monthly = mean(contribution, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  # Join with climatology
  left_join(
    chem_climatology %>% select(month, group, contribution_mean),
    by = c("month", "group")
  ) %>%
  # Calculate anomaly and classify as positive/negative
  mutate(
    anomaly = contribution_monthly - contribution_mean,
    anomaly_type = if_else(anomaly >= 0, "Positive", "Negative")
  )

# Plot faceted anomalies
ggplot(chem_anomalies_monthly, aes(x = year_month, y = anomaly, fill = anomaly_type)) +
  geom_hline(yintercept = 0, color = "black", linewidth = 0.5) +
  geom_bar(stat = "identity", width = 25) +
  facet_wrap(~ group, ncol = 1, scales = "free_y", strip.position = "right") +
  scale_fill_manual(
    values = c("Positive" = "#D32F2F", "Negative" = "#1976D2"),
    guide = "none"
  ) +
  scale_x_date(limits = as.Date(c("2016-01-01", "2025-12-31")),
               expand = c(0, 0),
               date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(expand = c(0.02, 0), labels = scales::number_format(accuracy = 0.01)) +
  labs(
    y = expression(paste("Biomass anomaly (mg ", m^{-3}, ")")),
  ) +
  theme_bw() +
  theme(
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold", size = 28, color = "black", angle = 270),
    strip.placement = "outside",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.spacing = unit(2, "lines"),  # Add gap between facets
    axis.title.x = element_blank(),
    axis.title.y = element_text(size = 28, color = "black"),
    axis.text = element_text(size = 28, color = "black"),
  )

ggsave(here("figures", "phytoplankton_anomalies_faceted.png"), 
       width = 16, height = 16, dpi = 300)
```

```{r}
#==============================================================================
# CHEMTAX Community Clustering Analysis
#==============================================================================

library(vegan)
library(cluster)
library(factoextra)
library(ggdendro)
library(ggplot2)
library(patchwork)
library(tidyverse)
library(here)

#------------------------------------------------------------------------------
# 1. PREPARE DATA
#------------------------------------------------------------------------------

# Reshape CHEMTAX data to wide format
chem_wide <- chem_c_tchla_combined %>%
  select(date, group, contribution) %>%
  pivot_wider(names_from = group, values_from = contribution, values_fill = 0)

# Create matrix for clustering
chem_matrix <- chem_wide %>%
  select(-date) %>%
  as.matrix()
rownames(chem_matrix) <- chem_wide$date

# Calculate relative composition
chem_rel <- chem_matrix / rowSums(chem_matrix)

#------------------------------------------------------------------------------
# 2. COLOR SCHEMES
#------------------------------------------------------------------------------

# NPG color palette for taxa
npg_distinct_colors <- c(
  "#E64B35",  # Red - diat
  "#4DBBD5",  # Light blue - raph
  "#00A087",  # Teal - dict
  "#3C5488",  # Dark blue - dino
  "#F39B7F",  # Orange - cryp
  "#8491B4",  # Purple - GA
  "#91D1C2",  # Light teal - hapt
  "#FFC107"   # Golden yellow - cyan
)

taxon_order <- c("diat", "raph", "dict", "dino", "cryp", "GA", "hapt", "cyan")
taxon_colors <- setNames(npg_distinct_colors[1:length(taxon_order)], taxon_order)

# Season colors - organized and visually distinct
season_colors <- c(
  "Winter" = "#3B4CC0",  # Deep blue
  "Spring" = "#7FBC41",  # Fresh green
  "Summer" = "#F46D43",  # Warm orange
  "Fall" = "#9E6F3E"     # Earthy brown
)

# Season order
season_order <- c("Winter", "Spring", "Summer", "Fall")

#------------------------------------------------------------------------------
# 3. CLUSTERING FUNCTION
#------------------------------------------------------------------------------

perform_clustering <- function(data_matrix, method = "relative") {
  
  # Always use Bray-Curtis (both datasets are compositional)
  dist_mat <- vegdist(data_matrix, method = "bray")
  
  # Use average linkage for both
  linkage <- "average"
  
  hc <- hclust(dist_mat, method = linkage)
  
  coph <- cophenetic(hc)
  cat("\n", method, "- Bray-Curtis +", linkage, 
      "| Cophenetic cor:", round(cor(dist_mat, coph), 3), "\n")
  
  return(list(hc = hc, dist = dist_mat, linkage = linkage))
}

#------------------------------------------------------------------------------
# 4. PLOTTING FUNCTION
#------------------------------------------------------------------------------

create_cluster_figure <- function(data_matrix, hc_obj, k, method = "relative",
                                  save_name) {
  
  # Cut tree
  clusters <- cutree(hc_obj, k = k)
  
  # Create clustered dataframe
  chem_clustered <- chem_wide %>%
    mutate(
      community_cluster = factor(clusters),
      total_biomass = rowSums(chem_matrix),
      season = case_when(
        format(date, "%m-%d") >= "03-20" & format(date, "%m-%d") <= "06-20" ~ "Spring",
        format(date, "%m-%d") >= "06-21" & format(date, "%m-%d") <= "09-21" ~ "Summer",
        format(date, "%m-%d") >= "09-22" & format(date, "%m-%d") <= "12-20" ~ "Fall",
        TRUE ~ "Winter"
      ),
      season = factor(season, levels = season_order)  # Order seasons
    )
  
  # Cluster sizes
  cluster_sizes <- chem_clustered %>%
    count(community_cluster) %>%
    mutate(label = paste0("n = ", n))
  
  # Cluster profiles
  cluster_profiles <- chem_clustered %>%
    pivot_longer(cols = -c(date, community_cluster, total_biomass, season),
                 names_to = "taxon", values_to = "biomass") %>%
    group_by(community_cluster, taxon) %>%
    summarise(
      mean_biomass = mean(biomass),
      mean_proportion = mean(biomass / (total_biomass + 0.001)),
      .groups = "drop"
    )
  
  #--- Panel A: Community Composition ---
  if (method == "relative") {
    # Stacked bar showing proportions
    p_comp <- cluster_profiles %>%
      mutate(taxon = factor(taxon, levels = taxon_order)) %>%
      ggplot(aes(x = community_cluster, y = mean_proportion, fill = taxon)) +
      geom_col(width = 0.7) +
      geom_text(data = cluster_sizes,
                aes(x = community_cluster, y = 1.05, label = label, fill = NULL),
                size = 5.5, fontface = "bold", vjust = 0) +
      scale_fill_manual(values = taxon_colors, name = "Taxon") +
      scale_y_continuous(labels = scales::percent, 
                        expand = expansion(mult = c(0, 0.1))) +
      labs(
        title = "Mean Community Composition by Cluster",
        subtitle = "Bray-Curtis distance, average linkage on relative abundance",
        x = "Community Cluster",
        y = "Mean Proportion of Community"
      )
  } else {  # absolute
    # Stacked bar showing absolute biomass
    p_comp <- cluster_profiles %>%
      mutate(taxon = factor(taxon, levels = taxon_order)) %>%
      ggplot(aes(x = community_cluster, y = mean_biomass, fill = taxon)) +
      geom_col(width = 0.7) +
      geom_text(data = cluster_sizes,
                aes(x = community_cluster, 
                    y = max(cluster_profiles$mean_biomass) * 1.05, 
                    label = label, fill = NULL),
                size = 5.5, fontface = "bold", vjust = 0) +
      scale_fill_manual(values = taxon_colors, name = "Taxon") +
      scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
      labs(
        title = "Mean Community Composition by Cluster",
        subtitle = "Bray-Curtis distance, average linkage on absolute biomass",
        x = "Community Cluster",
        y = expression(bold("Mean TChla (mg m"^-3*")"))
      )
  }
  
  p_comp <- p_comp +
    theme_minimal(base_size = 16) +
    theme(
      axis.text.x = element_text(size = 14, face = "bold"),
      axis.title.x = element_text(size = 16, face = "bold"),
      axis.title.y = element_text(size = 16),
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 14, hjust = 0.5),
      legend.position = "right",
      legend.text = element_text(size = 14),
      legend.title = element_text(size = 15, face = "bold"),
      panel.grid.major.x = element_blank()
    )
  
  #--- Panel B: Total Biomass ---
  p_biomass <- chem_clustered %>%
    ggplot(aes(x = community_cluster, y = total_biomass, fill = community_cluster)) +
    geom_boxplot(outlier.size = 1.5) +
    scale_y_log10() +
    scale_fill_manual(values = npg_distinct_colors[1:k]) +
    labs(
      title = "Total Chlorophyll-a by Cluster",
      x = "Community Cluster",
      y = expression(bold("TChla (mg m"^-3*", log scale)"))
    ) +
    theme_minimal(base_size = 16) +
    theme(
      legend.position = "none",
      axis.text = element_text(size = 14),
      axis.title.x = element_text(size = 16, face = "bold"),
      axis.title.y = element_text(size = 16),
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
      panel.grid.major.x = element_blank()
    )
  
  #--- Panel C: Seasonality ---
  p_season <- chem_clustered %>%
    count(community_cluster, season) %>%
    group_by(community_cluster) %>%
    mutate(prop = n / sum(n)) %>%
    ggplot(aes(x = community_cluster, y = prop, fill = season)) +
    geom_col(position = "stack", width = 0.7) +
    geom_text(aes(label = paste0(round(prop * 100), "%")),
              position = position_stack(vjust = 0.5),
              size = 5, fontface = "bold", color = "white") +
    scale_fill_manual(values = season_colors, 
                     breaks = season_order) +  # Ensures legend order
    scale_y_continuous(labels = scales::percent, 
                      expand = expansion(mult = c(0, 0.05))) +
    labs(
      title = "Seasonal Distribution by Cluster",
      x = "Community Cluster",
      y = "Proportion of Samples",
      fill = "Season"
    ) +
    theme_minimal(base_size = 16) +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 16, face = "bold"),
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
      legend.position = "right",
      legend.text = element_text(size = 14),
      legend.title = element_text(size = 15, face = "bold"),
      panel.grid.major.x = element_blank()
    )
  
  #--- Panel D: Dendrogram ---
  dend_data <- dendro_data(hc_obj)
  
  dend_data$labels <- dend_data$labels %>%
    mutate(cluster = clusters[match(label, names(clusters))])
  
  terminal_segs <- dend_data$segments %>%
    filter(yend == 0) %>%
    left_join(dend_data$labels %>% select(x, cluster), by = "x")
  
  p_dend <- ggplot() +
    geom_segment(data = dend_data$segments,
                 aes(x = x, y = y, xend = xend, yend = yend),
                 color = "gray50", linewidth = 0.5) +
    geom_segment(data = terminal_segs,
                 aes(x = x, y = y, xend = xend, yend = yend, 
                     color = factor(cluster)),
                 linewidth = 1.2) +
    scale_color_manual(values = npg_distinct_colors[1:k]) +
    labs(x = NULL, y = "Bray-Curtis Distance") +
    theme_minimal(base_size = 16) +
    theme(
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.text.y = element_text(size = 14),
      axis.title.y = element_text(size = 16, face = "bold"),
      panel.grid.major.x = element_blank(),
      legend.position = "none"
    )
  
  #--- Combine panels ---
  p_final <- p_comp / (p_biomass | p_season) / p_dend +
    plot_layout(heights = c(1.5, 1, 1.2))
  
  print(p_final)
  ggsave(here("figures", save_name),
         plot = p_final, width = 16, height = 16, dpi = 300, bg = "white")
  
  return(list(plot = p_final, clusters = chem_clustered))
}

#------------------------------------------------------------------------------
# 5. RUN ANALYSES
#------------------------------------------------------------------------------

# RELATIVE ABUNDANCE CLUSTERING
cat("\n=== RELATIVE ABUNDANCE CLUSTERING ===")
rel_results <- perform_clustering(chem_rel, method = "relative")
rel_output <- create_cluster_figure(
  data_matrix = chem_rel,
  hc_obj = rel_results$hc,
  k = 4,
  method = "relative",
  save_name = "chemtax_clusters_relative_complete.png"
)

# ABSOLUTE BIOMASS CLUSTERING
cat("\n=== ABSOLUTE BIOMASS CLUSTERING ===")
abs_results <- perform_clustering(chem_matrix, method = "absolute")
abs_output <- create_cluster_figure(
  data_matrix = chem_matrix,
  hc_obj = abs_results$hc,
  k = 4,
  method = "absolute",
  save_name = "chemtax_clusters_absolute_complete.png"
)

#------------------------------------------------------------------------------
# 6. COMPARE CLUSTERING METHODS
#------------------------------------------------------------------------------

# Extract cluster assignments
rel_clusters <- rel_output$clusters %>% select(date, rel_clust = community_cluster)
abs_clusters <- abs_output$clusters %>% select(date, abs_clust = community_cluster)

comparison <- left_join(rel_clusters, abs_clusters, by = "date")

cat("\n=== CLUSTER COMPARISON ===\n")
print(table(comparison$rel_clust, comparison$abs_clust))
```

```{r}
#------------------------------------------------------------------------------
# Updated color schemes for clusters (different from taxa but complementary)
#------------------------------------------------------------------------------

# Cluster colors - darker, more muted tones to contrast with taxa
cluster_colors <- c(
  "1" = "#B8860B",  # Dark goldenrod - Mixed
  "2" = "#2E8B57",  # Sea green - Diatoms
  "3" = "#8B4513",  # Saddle brown - Dinoflagellates
  "4" = "#4682B4"   # Steel blue - Winter
)

# Cluster labels with descriptions
cluster_labels <- c(
  "1" = "1 (Mixed)",
  "2" = "2 (Diatoms)",
  "3" = "3 (Dinoflagellates)",
  "4" = "4 (Winter)"
)

#------------------------------------------------------------------------------
# Create seasonal background shading data (Spring and Summer only)
#------------------------------------------------------------------------------

# Create continuous seasonal background for each year
years <- 2016:2025
seasonal_backgrounds <- map_df(years, function(year) {
  data.frame(
    season = c("Spring", "Summer"),
    year = year,
    start_date = as.Date(c(
      paste0(year, "-03-20"),       # Spring
      paste0(year, "-06-21")        # Summer
    )),
    end_date = as.Date(c(
      paste0(year, "-06-20"),       # Spring ends
      paste0(year, "-09-21")        # Summer ends
    ))
  )
}) %>%
  # Keep only dates within our plot range
  filter(start_date >= as.Date("2016-01-01") & end_date <= as.Date("2025-12-31")) %>%
  mutate(season = factor(season, levels = c("Spring", "Summer")))

#------------------------------------------------------------------------------
# Create plots
#------------------------------------------------------------------------------

# Create main plot with spring and summer shading only
p_main <- ggplot() +
  # Add seasonal background shading - Spring and Summer only
  geom_rect(data = seasonal_backgrounds,
            aes(xmin = start_date, xmax = end_date, ymin = 0, ymax = Inf, 
                fill = season),
            alpha = 0.15) +
  
  # Area plot for pre-2020-02-11
  geom_area(data = data_area_early,
            aes(x = date, y = contribution, fill = fct_rev(group)),
            position = "stack", alpha = 0.9) +
  # Single bar for 2020-02-11
  geom_bar(data = data_bar_2020,
           aes(x = date, y = contribution, fill = fct_rev(group)),
           position = "stack", stat = "identity", width = 20) +
  # Area plot for mid period
  geom_area(data = data_area_mid,
            aes(x = date, y = contribution, fill = fct_rev(group)),
            position = "stack", alpha = 0.9) +
  # Bar plot for 2024-2025
  geom_bar(data = data_bars_late,
           aes(x = date, y = contribution, fill = fct_rev(group)),
           position = "stack", stat = "identity", width = 20) +
  
  scale_fill_manual(
    values = c(taxon_colors, season_colors[c("Spring", "Summer")]),
    breaks = names(taxon_colors),
    name = NULL
  ) +
  scale_x_date(limits = as.Date(c("2016-01-01", "2025-12-31")),
               expand = c(0, 0),
               date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(expand = c(0, 0)) +  # Add this line - starts y-axis at zero
  labs(
    y = expression(paste("Phytoplankton biomass (mg ", m^{-3}, ")")),
  ) +
  theme_bw() +
  theme(
    legend.position = "right",
    legend.key.height = unit(0.6, "cm"),
    legend.key.width = unit(0.8, "cm"),
    legend.title = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    text = element_text(size = 28, color = "black"),
    plot.margin = margin(5.5, 5.5, 0, 5.5)
  )

# Create cluster strip panel (narrower, thicker bars, single-row legend)
p_clusters <- ggplot(cluster_points, aes(x = date, y = 1, fill = community_cluster)) +
  geom_tile(height = 0.5, width = 25) +  # Narrower height, thicker bars
  scale_fill_manual(
    values = cluster_colors,
    labels = cluster_labels,
    name = "Community Cluster"
  ) +
  scale_x_date(limits = as.Date(c("2016-01-01", "2025-12-31")),
               expand = c(0, 0),
               date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(expand = c(0, 0)) +
  theme_bw() +
  theme(
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.key.height = unit(0.5, "cm"),
    legend.key.width = unit(1.2, "cm"),
    legend.title = element_text(size = 24, face = "bold", hjust = 0.5),
    legend.text = element_text(size = 20),
    legend.margin = margin(t = 5, b = 5),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    text = element_text(size = 28, color = "black"),
    plot.margin = margin(0, 5.5, 5.5, 5.5)
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    title.hjust = 0.5,
    nrow = 1  # Force single row
  ))

# Combine with patchwork
library(patchwork)
p_combined <- p_main / p_clusters + 
  plot_layout(heights = c(12, 1))

print(p_combined)
ggsave(here("figures", "phytoplankton_community_composition_combined_clusters.png"), 
       width = 16, height = 7.5, dpi = 300)
```

```{r}
#==============================================================================
# INTERANNUAL VARIABILITY ANALYSIS (2016-2023 ONLY)
#==============================================================================

library(vegan)
library(tidyverse)
library(here)
library(patchwork)

#------------------------------------------------------------------------------
# Filter to 2016-2023 only
#------------------------------------------------------------------------------

abs_output_filtered <- abs_output$clusters %>%
  mutate(year = year(date)) %>%
  filter(year >= 2016 & year <= 2023)

#------------------------------------------------------------------------------
# 1. ANNUAL CLUSTER COMPOSITION (STACKED BARS)
#------------------------------------------------------------------------------

cluster_stats <- abs_output_filtered %>%
  group_by(year) %>%
  summarise(
    n_samples = n(),
    cluster1_prop = sum(community_cluster == "1") / n(),
    cluster2_prop = sum(community_cluster == "2") / n(),
    cluster3_prop = sum(community_cluster == "3") / n(),
    cluster4_prop = sum(community_cluster == "4") / n(),
    .groups = "drop"
  )

# Plot stacked bar chart
p_annual <- cluster_stats %>%
  pivot_longer(cluster1_prop:cluster4_prop, 
               names_to = "cluster", values_to = "proportion") %>%
  mutate(
    cluster = str_remove(cluster, "_prop"),
    cluster = str_replace(cluster, "cluster", ""),
    cluster = factor(cluster, levels = c("1", "2", "3", "4"))
  ) %>%
  ggplot(aes(x = factor(year), y = proportion, fill = cluster)) +
  geom_col(width = 0.7) +
  geom_text(data = cluster_stats, 
            aes(x = factor(year), y = 1.05, label = paste0("n=", n_samples), fill = NULL),
            size = 4.5, fontface = "bold") +
  scale_fill_manual(
    values = cluster_colors,
    labels = cluster_labels,
    name = "Community\nCluster"
  ) +
  scale_y_continuous(labels = scales::percent, 
                    expand = expansion(mult = c(0, 0.12))) +
  labs(
    title = "Interannual Variation in Community Cluster Composition (2016-2023)",
    x = "Year",
    y = "Proportion of Samples"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 15, face = "bold"),
    panel.grid.major.x = element_blank(),
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 16, face = "bold"),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5)
  )

print(p_annual)
ggsave(here("figures", "annual_cluster_composition_2016_2023.png"),
       width = 12, height = 7, dpi = 300, bg = "white")

#------------------------------------------------------------------------------
# 2. NMDS TRAJECTORY ANALYSIS
#------------------------------------------------------------------------------

annual_clusters <- abs_output_filtered %>%
  count(year, community_cluster) %>%
  group_by(year) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup()

annual_wide <- annual_clusters %>%
  pivot_wider(
    id_cols = year,
    names_from = community_cluster,
    values_from = prop,
    values_fill = 0
  ) %>%
  arrange(year)

# NMDS ordination
set.seed(123)
nmds_years <- metaMDS(annual_wide %>% select(-year), 
                      distance = "bray", 
                      k = 2, 
                      trymax = 100)

# Extract scores
nmds_scores <- data.frame(
  NMDS1 = nmds_years$points[, 1],
  NMDS2 = nmds_years$points[, 2],
  year = annual_wide$year
)

# NMDS plot
p_nmds <- ggplot(nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  geom_path(arrow = arrow(length = unit(0.3, "cm"), type = "closed"),
            linewidth = 1, alpha = 0.5, color = "gray40") +
  geom_point(aes(fill = year), size = 7, shape = 21, color = "black", stroke = 1.5) +
  geom_text(aes(label = year), size = 4.5, fontface = "bold") +
  scale_fill_gradient(low = "#3B4CC0", high = "#F46D43", name = "Year") +
  labs(
    title = "Interannual Trajectory of Community Composition (2016-2023)",
    subtitle = paste0("NMDS Stress = ", round(nmds_years$stress, 3)),
    caption = "Arrows show temporal progression; distance = compositional dissimilarity"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),
    plot.caption = element_text(size = 11, hjust = 0),
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 16, face = "bold"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1)
  )

print(p_nmds)
ggsave(here("figures", "nmds_interannual_trajectory_2016_2023.png"),
       width = 10, height = 9, dpi = 300, bg = "white")

#------------------------------------------------------------------------------
# 3. STATISTICAL TESTS
#------------------------------------------------------------------------------

# Chi-square test
cluster_year_table <- table(
  abs_output_filtered$year,
  abs_output_filtered$community_cluster
)

cat("\n=== CHI-SQUARE TEST (2016-2023) ===\n")
chisq_result <- chisq.test(cluster_year_table)
print(chisq_result)

# PERMANOVA
cat("\n=== PERMANOVA (2016-2023) ===\n")
permanova_result <- adonis2(
  annual_wide %>% select(-year) ~ year,
  data = annual_wide,
  method = "bray",
  permutations = 999
)
print(permanova_result)

# Specific contrast: 2020-2021 vs others
years_2020_2021 <- annual_wide %>%
  mutate(period = if_else(year %in% c(2020, 2021), "2020-2021", "Other"))

perm_2020_2021 <- adonis2(
  years_2020_2021 %>% select(-year, -period) ~ period,
  data = years_2020_2021,
  method = "bray",
  permutations = 999
)

cat("\n=== 2020-2021 vs Other Years (2016-2023) ===\n")
print(perm_2020_2021)

#------------------------------------------------------------------------------
# 4. COMBINED FIGURE
#------------------------------------------------------------------------------

p_combined <- p_annual / p_nmds +
  plot_layout(heights = c(1, 1.2))

print(p_combined)
ggsave(here("figures", "interannual_variability_2016_2023.png"),
       width = 14, height = 14, dpi = 300, bg = "white")

#------------------------------------------------------------------------------
# 5. SUMMARY STATISTICS
#------------------------------------------------------------------------------

# Sample sizes and cluster diversity
summary_table <- cluster_stats %>%
  mutate(
    dominant_cluster = case_when(
      cluster1_prop == pmax(cluster1_prop, cluster2_prop, cluster3_prop, cluster4_prop) ~ "1 (Mixed)",
      cluster2_prop == pmax(cluster1_prop, cluster2_prop, cluster3_prop, cluster4_prop) ~ "2 (Diatoms)",
      cluster3_prop == pmax(cluster1_prop, cluster2_prop, cluster3_prop, cluster4_prop) ~ "3 (Dinoflagellates)",
      cluster4_prop == pmax(cluster1_prop, cluster2_prop, cluster3_prop, cluster4_prop) ~ "4 (Winter)"
    ),
    diversity = -1 * (
      cluster1_prop * log(cluster1_prop + 0.001) +
      cluster2_prop * log(cluster2_prop + 0.001) +
      cluster3_prop * log(cluster3_prop + 0.001) +
      cluster4_prop * log(cluster4_prop + 0.001)
    )
  ) %>%
  select(year, n_samples, dominant_cluster, diversity)

cat("\n=== ANNUAL SUMMARY (2016-2023) ===\n")
print(summary_table)

write_csv(summary_table, here("outputs", "annual_cluster_summary_2016_2023.csv"))
```


























