---
title: "R Notebook"
output: html_notebook
---

Some new interpolation tutorials to consider:
https://search.r-project.org/CRAN/refmans/rioja/html/interp.dataset.html
https://github.com/hdugan/NTLlakeloads

```{r}
#Upload packages
library(tidyverse)
library(here)
library(readxl)
library(patchwork)
library(lubridate)
library(MBA)
library(mgcv)
library(FNN)
library(zoo)
library(reshape2)
library(rioja)
library(egg)
library(palr)
library(ggsci)
library(gsw)

```

```{r}
#QC'd Buoy fluorescence data
#Put buoy QC pipline into Claude for suggestions.

#2022
b_f <- read.csv(here("outputs", "qc_buoy_2025-09-08.csv"))

#Buoy salinity data
buoy_ts <- read.csv(here("files", "ts_2025-09-08.csv"))

#Corrected CTD fluorescence data
ctd_fl <- read_csv(here("outputs", "qc_quench_kc10_fzh01_2025-09-08.csv"))

#Downloading discrete chlorophyll samples - This could be done using the API
cd <- read_csv(here("files", "chl_kc10_fzh01_2025-09-08.csv"))

ctd <- read_csv(here("files", "ctd_kc10_fzh01_2025-08-09.csv"))

#cm = chlorophylly march 
cm <- read_csv(here("files", "chl_2022-03-09.csv")) 
#cs = chlorophyll september
cs <- read_csv(here("files", "chl_2022-09-09.csv")) 

#CHEMTAX outputs
chem <- read_csv(here("files", "chemtax_kc10_2024.csv"))

#I think here I am downloading all of the wind data from the lookout?
wind <- read_csv(here("files", "lo_wind_2025-09-08.csv"))

weath <- read_csv(here("files", "enviro_weather_2025-04-14.csv"))
```


```{r}
ctd_calc <- ctd %>% 
  mutate(date = date(`Measurement time`)) %>%
  filter(`Cast Direction Flag` == "d") %>% 
  # filter(is.na(`Fluorometry Chlorophyll flag`)) %>% 
  select(castpk = `Cast PK`,
         ctd_num =`CTD serial number`,
         date, m_time = `Measurement time`,
         station = Station,
         longitude = `Station Longitude`,
         latitude = `Station Latitude`,
         pres = `Pressure (dbar)`,
         sal = `Salinity (PSU)`,
         temp = `Temperature (deg C)`) %>%
  mutate(
    # Calculate absolute salinity from practical salinity
    sa = gsw_SA_from_SP(sal, pres, longitude, latitude),  # Adjust lat/lon for your study area
    # Calculate conservative temperature from in-situ temperature
    ct = gsw_CT_from_t(sa, temp, pres),
    # Calculate in-situ density (kg/m³)
    density = gsw_rho(sa, ct, pres),
    # Calculate potential density anomaly (sigma-theta, kg/m³ - 1000)
    sigma_theta = gsw_sigma0(sa, ct)
  )

daily_ctd <- ctd_calc %>%
  filter(!is.na(sal), !is.na(temp), !is.na(sigma_theta)) %>%  # Remove missing values
  
  # Step 1: Calculate daily means by depth
  group_by(date, pres) %>%
  summarise(
    sal_daily = mean(sal, na.rm = TRUE),
    temp_daily = mean(temp, na.rm = TRUE),
    sigma_theta_daily = mean(sigma_theta, na.rm = TRUE),
    .groups = 'drop'
  )
```




```{r}
#Pulling out discharge model outputs for each watershed type and pivoting to long format for plotting
q <- weath %>% 
  select(date, Q_GM, Q_SM, Q_RA) %>% 
  pivot_longer(c(Q_GM:Q_RA), names_to = "Watershed_group", values_to = "Q") %>% 
  drop_na() %>% 
  group_by(date) %>% 
  mutate(n = n()) %>% 
  ungroup() %>% 
  mutate(year = year(date))
```

```{r}
#Pulling out the median nightly buoy fluorescence value from my QC process
buoy_fl <- b_f %>% 
  select(date = date_corr, fl_med_day, group) %>% 
  distinct() %>% 
  mutate(date = ymd(date),
         year = year(date),
         month = month(date),
         yday = yday(date)) %>%
  filter(year %in% c(2022, 2023, 2024, 2025)) %>% 
  mutate(group = as.character(group))

ctd_fl <- ctd_fl %>% 
  mutate(year = year(date))
```

```{r}
#Pulling out buoy salinity data without flags for 2022 and 2024 and calculating daily mean
buoy_ts <- buoy_ts %>% 
  mutate(measurementTime = mdy_hm(measurementTime),
         date = date(measurementTime)) %>% 
  filter(year %in% c(2022, 2024, 2025)) %>% 
  group_by(date) %>% 
  summarise(mean_sal = mean(WaterSalinity[WaterSalinity_UQL == 2], na.rm = TRUE),
            mean_temp = mean(WaterTemp[WaterTemp_UQL == 2], na.rm = TRUE),
            .groups = "drop")

wind_dm <- wind %>% 
  mutate(measurementTime = mdy_hm(measurementTime),
         date = date(measurementTime)) %>% 
  filter(year %in% c(2022, 2024, 2025)) %>% 
  group_by(date) %>% 
  summarise(WindSpd_Med = median(WindSpd_Avg[WindSpd_UQL == 2], na.rm = TRUE),
            WindDir_Med = median(WindDir_Avg[WindDir_UQL == 2], na.rm = TRUE),
            .groups = "drop") %>% 
  mutate(year = year(date))
  
```


```{r}
#Pulling out the Bulk chlorophyll data for 2022, setting the 0m depth to 1m to join with the CTD fluorometer data and then changing an issue sample with the size-fractionated sum concentration
cd <- cd %>% 
  filter(filter_type == "Bulk GF/F" & line_out_depth == 0) %>% 
  select(date, chla) %>% 
  mutate(chla = case_when(date == "2022-05-05" ~ 1.41,
                          TRUE ~ as.numeric(chla)))
```

```{r}
#There were two saturated CTD casts in 2022 and here, I am prepping to iterpolate from discrete sample profiles - this is OK here as they are mixed conditions lacking strong peaks.

#Wrangling the March 2022 discrete chlorophyll fluorescence profile
cm <- cm %>% 
  filter(filter_type == "Bulk GF/F") %>% 
  select(date, pres = line_out_depth, chla) %>% 
  mutate(pres = case_when(pres == 0 ~ 1,
                          TRUE ~ as.numeric(pres)))
#Wrangling the September 2022 discrete chlorophyll fluorescence profile
cs <- cs %>% 
  filter(filter_type == "Bulk GF/F") %>% 
  select(date, pres = line_out_depth, chla) %>% 
  mutate(pres = case_when(pres == 0 ~ 1,
                          TRUE ~ as.numeric(pres)))

#Combining the MArch and September discrete chlorophyll profile
c_interp <- rbind(cm, cs)

#Converting discrete chlorophyll profiles to wide format.
c_interp <- c_interp %>% 
  pivot_wider(names_from = "date", values_from = "chla")
```


```{r}
#Performing the interpolation.

# Select chlorophyll data and depths
spec <- c_interp %>%
  select(`2022-03-09`, `2022-09-09`)

depth <- c_interp$pres

# Interpolate to 1m intervals covering full depth range
x.new <- seq(1, max(depth), by = 1)  # Goes to 325m now
sp.interp <- interp.dataset(y = spec, x = depth, xout = x.new,
                           method = "loess", span = 0.8)

# Create interpolated dataframe
interp <- as.data.frame(sp.interp) %>% 
  mutate(pres = x.new) %>% 
  pivot_longer(cols = 1:2, names_to = "date", values_to = "f_npq") %>% 
  mutate(date = as.Date(date),
         year = year(date),
         f_npq = round(f_npq, 2)) %>% 
  select(date, year, pres, f_npq)
```

```{r}
#Wrangling the buoy fluorometer data and joining 2022 and 2024 with both
buoy_fl <- buoy_fl %>% 
  left_join(cd) %>% 
  left_join(buoy_ts)
```

```{r}
#Working with chemtax data to make it easy to plot

#Making the date column a date format
chem <- chem %>% 
  mutate(date = lubridate::mdy(Date)) %>%
  select(date, cyan = Cyanobacteria, hapt = Hapto, 
         GA = `Prasinophytes-3`, cryp = Cryptophytes,
         dino = `Dinoflagellates-1`, raph = Raphido,
         dict = Dictyo, diat = `Diatoms-1`) %>% #rename groups
  pivot_longer(c(cyan:diat), names_to = "group",
               values_to = "contribution") %>%  #pivot longer
  group_by(date, group) %>% 
  summarise(contribution = mean(contribution)) %>% #Calculating daily mean for duplicates.
  ungroup() %>% 
  group_by(date) %>% 
  mutate(tchla = sum(contribution)) %>% #Calculating TChla concentrations for each day
  ungroup()


#checking to see if there are any duplicates - there were replicates taken for DFO comparisons. None found because I already averaged these for the manuscript.
chem_dup <- chem%>%
  distinct(date, tchla) %>% 
  group_by(date) %>% 
  mutate(dup = n()) %>% 
  ungroup() %>% 
  filter(dup > 1)

#Good to move forward
```



```{r}
#Creating the 2022 wind speed cubed plot - what if i added wind direction or vector here?
f_wind_22 <- wind_dm %>%
  filter(year == 2022) %>%
  ggplot() +
  geom_line(aes(x = date, y = WindSpd_Med^3),
            size = 2) +
  ylim(0, 6000) +
  labs(y = bquote(Wind~"("*m^3*s^3*")")) +
  scale_x_date(limits = as_date(c("2022-01-01", "2022-12-31")),
               expand = c(0, 0),date_breaks = "months", date_labels = "%b") +
  theme_bw() +
  theme(text = element_text(size = 35), #35
        axis.text = element_text(color = "black"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

print(f_wind_22)
```

```{r}
#Creating the 2022 wind speed cubed plot - what if i added wind direction or vector here?
f_wind_24 <- wind_dm %>%
  filter(year == 2024) %>%
  ggplot() +
  geom_line(aes(x = date, y = WindSpd_Med^3),
            size = 2) +
  ylim(0, 6000) +
  labs(y = bquote(Wind~"("*m^3*s^-3*")")) +
  scale_x_date(limits = as_date(c("2024-01-01", "2024-12-31")),
               expand = c(0, 0),date_breaks = "months", date_labels = "%b") +
  theme_bw() +
  theme(text = element_text(size = 35), #35
        axis.text = element_text(color = "black"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

print(f_wind_24)
```

```{r}
#Creating the 2022 wind speed cubed plot - what if i added wind direction or vector here?
f_wind_25 <- wind_dm %>%
  filter(year == 2025) %>%
  ggplot() +
  geom_line(aes(x = date, y = WindSpd_Med^3),
            size = 2) +
  ylim(0, 6000) +
  labs(y = bquote(Wind~"("*m^3*s^-3*")")) +
  scale_x_date(limits = as_date(c("2025-01-01", "2025-12-31")),
               expand = c(0, 0),date_breaks = "months", date_labels = "%b") +
  theme_bw() +
  theme(text = element_text(size = 35), #35
        axis.text = element_text(color = "black"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

print(f_wind_25)
```

```{r}
#Setting up the joined buoy surface discrete chlorophyll 2m nightly median fluorescence and 2m daily mean salinity/temperature for plotting - pivoting long.

buoy_fl_long <- buoy_fl %>%
  select(date_corr, chla, fl_med_day, mean_sal, mean_temp) %>% 
  pivot_longer(c(chla, fl_med_day, mean_sal, mean_temp),
              names_to = "par", values_to = "val") %>% 
  mutate(date = date(date_corr),
         year = year(date))  
```

```{r}
#Creating buoy figure for 2022 - discrete surface chlorophyll, daily fluorescence/temp/sal
f_buoy_22 <- buoy_fl_long %>% 
  filter(year == 2022) %>% 
  ggplot(aes(x = date, y = val, color = par)) +
  geom_line(data = filter(buoy_fl_long,
                          par == "fl_med_day"),
            size = 2) +
  geom_line(data = filter(buoy_fl_long,
                          par == "mean_sal"),
            size = 2) +
  geom_line(data = filter(buoy_fl_long,
                          par == "mean_temp"),
            size = 2) +
  geom_point(data = filter(buoy_fl_long,
                          par == "chla"),
            size = 4, pch = 8, stroke = 2) +
  ggsci::scale_color_jama(labels = c(expression(Chl[Discrete]),
                                         expression(Chl[BUOY]),
                                         expression(Salinity[BUOY]),
                                     expression(Temp[BUOY]))) +
  scale_x_date(limits = as_date(c("2022-01-01", "2022-12-31")),
               expand = c(0, 0),date_breaks = "months", date_labels = "%b") +
  ylab(expression(atop(Chl~"(mg" ~ m^-3*")",
                       paste("Salinity,"~"Temp")))) +
  labs(color = NULL) +
  theme_bw() +
  theme(legend.position = "right",
        text = element_text(size = 35), #35
        axis.text = element_text(color = "black"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

print(f_buoy_22)
```

```{r}
#Creating buoy figure for 2022 - discrete surface chlorophyll, daily fluorescence/temp/sal
f_buoy_24 <- buoy_fl_long %>% 
  filter(year == 2024) %>% 
  ggplot(aes(x = date, y = val, color = par)) +
  geom_line(data = filter(buoy_fl_long,
                          par == "fl_med_day"),
            size = 2) +
  geom_line(data = filter(buoy_fl_long,
                          par == "mean_sal"),
            size = 2) +
  geom_line(data = filter(buoy_fl_long,
                          par == "mean_temp"),
            size = 2) +
  geom_point(data = filter(buoy_fl_long,
                          par == "chla"),
            size = 4, pch = 8, stroke = 2) +
  ggsci::scale_color_jama(labels = c(expression(Chl[Discrete]),
                                         expression(Chl[BUOY]),
                                         expression(Salinity[BUOY]),
                                     expression(Temp[BUOY]))) +
  scale_x_date(limits = as_date(c("2024-01-01", "2024-12-31")),
               expand = c(0, 0),date_breaks = "months", date_labels = "%b") +
  ylab(expression(atop(Chl~"(mg" ~ m^-3*")",
                       paste("Salinity,"~"Temp")))) +
  labs(color = NULL) +
  theme_bw() +
  theme(legend.position = "right",
        text = element_text(size = 35), #35
        axis.text = element_text(color = "black"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

print(f_buoy_24)
```
```{r}
#Creating buoy figure for 2022 - discrete surface chlorophyll, daily fluorescence/temp/sal
f_buoy_25 <- buoy_fl_long %>% 
  filter(year == 2025) %>% 
  ggplot(aes(x = date, y = val, color = par)) +
  geom_line(data = filter(buoy_fl_long,
                          par == "fl_med_day"),
            size = 2) +
  geom_line(data = filter(buoy_fl_long,
                          par == "mean_sal"),
            size = 2) +
  geom_line(data = filter(buoy_fl_long,
                          par == "mean_temp"),
            size = 2) +
  geom_point(data = filter(buoy_fl_long,
                          par == "chla"),
            size = 4, pch = 8, stroke = 2) +
  ggsci::scale_color_jama(labels = c(expression(Chl[Discrete]),
                                         expression(Chl[BUOY]),
                                         expression(Salinity[BUOY]),
                                     expression(Temp[BUOY]))) +
  scale_x_date(limits = as_date(c("2025-01-01", "2025-12-31")),
               expand = c(0, 0),date_breaks = "months", date_labels = "%b") +
  ylab(expression(atop(Chl~"(mg" ~ m^-3*")",
                       paste("Salinity,"~"Temp")))) +
  labs(color = NULL) +
  theme_bw() +
  theme(legend.position = "right",
        text = element_text(size = 35), #35
        axis.text = element_text(color = "black"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

print(f_buoy_25)
```



```{r}
#Adding in 2022 interpolated CTD fluorescence profiles to fill gap of bad data

ctd_fl <- ctd_fl %>% 
  mutate(year = year(date)) %>% 
  filter(year %in% c(2022, 2024, 2025)) %>% 
  select(date, year, pres, f_npq)

ctd_fl <- rbind(ctd_fl, interp)


```

```{r}
#Setting color palette

# Option 3: Viridis-inspired but with dark blue start
fluor_palette_v3 <- colorRampPalette(c(
  "#08306b",  # Deep navy blue
  "#1f4e7a",  # Dark blue
  "#2e6b89",  # Medium blue
  "#4d8fc7",  # Bright blue
  "#2fb3d4",  # Vivid cyan-blue (bloom threshold)
  "#00a693",  # Bright teal
  "#4daf4a",  # Vibrant green
  "#8cc152",  # Lime green
  "#ffd23f",  # Bright yellow
  "#ff8c42",  # Vivid orange
  "#e74c3c"   # Bold red-orange
))

# Generate color vectors (50 colors for smooth gradients)
colors_v3 <- fluor_palette_v3(50)

# Function to create breaks that emphasize bloom threshold
create_fluor_breaks <- function(max_val = 50, bloom_threshold = 5) {
  # More breaks in the 0-10 range to capture bloom dynamics
  c(0, 1, 2, 3, 4, bloom_threshold, 7, 10, 15, 20, 30, 40, max_val)
}

overall_range <- ctd_fl %>% 
  filter(pres < 51) %>% 
  summarise(min_val = min(f_npq, na.rm = TRUE),
            max_val = max(f_npq, na.rm = TRUE))
```

```{r}
#Creating CTD profile plot for each year.

f_ctd_fl_22 <- ctd_fl %>% 
  filter(pres < 51 & year == 2022) %>% 
  ggplot(aes(x = date)) +
  geom_tile(aes(y = pres, fill = f_npq)) +
  geom_hline(yintercept = 5,
             linetype = "dashed", size = 1, color = "white") +
  scale_y_reverse(breaks = seq(0, 50, by = 10)) +

  scale_fill_gradientn(colors = colors_v3,
                     values = scales::rescale(c(0, 2, 5, 10, 20, 50)),
                     limits = c(overall_range$min_val, overall_range$max_val)) +
  labs(fill = bquote(CTD[FLU]~"(mg" ~ m^-3*")"),
       y = "Depth") +
  scale_x_date(limits = as_date(c("2022-01-01", "2022-12-31")),
               expand = c(0, 0),date_breaks = "months", date_labels = "%b") +
  theme_bw() +
  theme(text = element_text(size = 38), #35
        axis.text = element_text(color = "black"),
        axis.title.x = element_blank(),
        # axis.text.x = element_blank(),
        legend.position = "right",
        legend.key.height = unit(1.8, "cm"),
        legend.title = element_text(size = 30, angle = 270),
        legend.title.align = 0.5,
        legend.direction = "vertical",
        axis.text.x = element_blank()
        ) +
    guides(fill = guide_colourbar(title.position = "right"))

print(f_ctd_fl_22)
```

```{r}
#Creating CTD profile plot for each year.

f_ctd_fl_24 <- ctd_fl %>% 
  filter(pres < 51 & year == 2024) %>% 
  ggplot(aes(x = date)) +
  geom_tile(aes(y = pres, fill = f_npq)) +

  geom_hline(yintercept = 5,
             linetype = "dashed", size = 1, color = "white") +
  scale_y_reverse(breaks = seq(0, 50, by = 10)) +
  scale_fill_gradientn(colors = colors_v3,
                     values = scales::rescale(c(0, 2, 5, 10, 20, 50)),
                     limits = c(overall_range$min_val, overall_range$max_val)) +
  labs(fill = bquote(CTD[FLU]~"(mg" ~ m^-3*")"),
       y = "Depth") +
  scale_x_date(limits = as_date(c("2024-01-01", "2024-12-31")),
               expand = c(0, 0),date_breaks = "months", date_labels = "%b") +
  theme_bw() +
  theme(text = element_text(size = 38), #35
        axis.text = element_text(color = "black"),
        axis.title.x = element_blank(),
        # axis.text.x = element_blank(),
        legend.position = "right",
        legend.key.height = unit(1.8, "cm"),
        legend.title = element_text(size = 30, angle = 270),
        legend.title.align = 0.5,
        legend.direction = "vertical",
        axis.text.x = element_blank()
        ) +
    guides(fill = guide_colourbar(title.position = "right"))

print(f_ctd_fl_24)
```
```{r}
#Creating CTD profile plot for each year.

f_ctd_fl_25 <- ctd_fl %>% 
  filter(pres < 51 & year == 2025) %>% 
  ggplot(aes(x = date)) +
  geom_tile(aes(y = pres, fill = f_npq), width = 20) +
  geom_hline(yintercept = 5,
             linetype = "dashed", size = 1, color = "white") +
  scale_y_reverse(breaks = seq(0, 50, by = 10)) +
  scale_fill_gradientn(colors = colors_v3,
                     values = scales::rescale(c(0, 2, 5, 10, 20, 50)),
                     limits = c(overall_range$min_val, overall_range$max_val)) +
  labs(fill = bquote(CTD[FLU]~"(mg" ~ m^-3*")"),
       y = "Depth") +
  scale_x_date(limits = as_date(c("2025-01-01", "2025-12-31")),
               expand = c(0, 0),date_breaks = "months", date_labels = "%b") +
  theme_bw() +
  theme(text = element_text(size = 38), #35
        axis.text = element_text(color = "black"),
        axis.title.x = element_blank(),
        # axis.text.x = element_blank(),
        legend.position = "right",
        legend.key.height = unit(1.8, "cm"),
        legend.title = element_text(size = 30, angle = 270),
        legend.title.align = 0.5,
        legend.direction = "vertical",
        axis.text.x = element_blank()
        ) +
    guides(fill = guide_colourbar(title.position = "right"))

print(f_ctd_fl_25)
```


```{r}


# First, modify plots to remove redundant axes and legends
# Wind plots - only leftmost gets y-axis, only bottom row gets x-axis
f_wind_22_mod <- f_wind_22 + 
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())

f_wind_24_mod <- f_wind_24 + 
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank())

f_wind_25_mod <- f_wind_25 + 
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank())

# Buoy plots - only leftmost gets y-axis and legend
f_buoy_22_mod <- f_buoy_22 + 
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none")

f_buoy_24_mod <- f_buoy_24 + 
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "none")

f_buoy_25_mod <- f_buoy_25 + 
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank())

# CTD plots - only leftmost gets y-axis, only rightmost gets legend, bottom row gets x-axis
f_ctd_fl_22_mod <- f_ctd_fl_22 + 
  theme(axis.text.x = element_text(color = "black"),
        legend.position = "none")

f_ctd_fl_24_mod <- f_ctd_fl_24 + 
  theme(axis.text.x = element_text(color = "black"),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "none")

f_ctd_fl_25_mod <- f_ctd_fl_25 + 
  theme(axis.text.x = element_text(color = "black"),
        axis.text.y = element_blank(),
        axis.title.y = element_blank()) # Keep legend on rightmost

# Combine plots
combined_plot <- (f_wind_22_mod | f_wind_24_mod | f_wind_25_mod) /
                 (f_buoy_22_mod | f_buoy_24_mod | f_buoy_25_mod) /
                 (f_ctd_fl_22_mod | f_ctd_fl_24_mod | f_ctd_fl_25_mod)

# Add column titles
combined_plot <- combined_plot + 
  plot_annotation(
    title = NULL,
    theme = theme(plot.title = element_text(size = 40))
  )

# Add year labels at the top
combined_plot_final <- wrap_elements(
  grid::textGrob("2022", gp = grid::gpar(fontsize = 35))) |
  wrap_elements(
  grid::textGrob("2024", gp = grid::gpar(fontsize = 35))) |
  wrap_elements(
  grid::textGrob("2025", gp = grid::gpar(fontsize = 35))) 

combined_plot_final <- combined_plot_final / combined_plot + 
  plot_layout(heights = c(0.05, 1))

test <- ggarrange(f_wind_22_mod, f_wind_24_mod, f_wind_25_mod,
                  f_buoy_22_mod, f_buoy_24_mod, f_buoy_25_mod,
                  f_ctd_fl_22_mod, f_ctd_fl_24_mod, f_ctd_fl_25_mod,
                        ncol = 3)

print(combined_plot_final)

ggsave(here("figures", "panel_kc10_buoy_2022_2024_2025.png"),
       test,
        width = 35, height = 12, dpi = 300)
```

```{r}
buoy_fl %>% 
  left_join(weath) %>% 
  left_join(wind_dm) %>% 
  filter(month %in% c(7)) %>% 
  filter(year == 2022) %>% 
  mutate(day = day(date)) %>% 
  ggplot(aes(x = lag(WindSpd_Med, 9), y = fl_med_day)) +
  geom_point()
```











```{r}
#Setting plotting order phytoplankton groups

#Order phytoplankton groups roughly from smallest to largest - create order list
order_chem <- c("cyan", "hapt", "GA", "cryp",
                   "dino", "raph", "dict", "diat")

#Chemtax full data - Specify order of phyto groups for figures
chem <- arrange(mutate(chem,
                                group = factor(group,
                                levels = order_chem)))
```

```{r}
f_chem_22 <- chem %>%
  ggplot() +
  geom_bar(aes(date, contribution, fill = fct_rev(group)),
           position = "stack", stat = "identity",
           alpha = 1, color = "black", size = 1) +
  ggsci::scale_fill_npg() +
  scale_x_date(limits = as.Date(c("2022-01-01", "2022-12-31")),
               expand = c(0, 0),
               date_breaks = "months", date_labels = "%b") +
  theme_bw() +
  labs(y = bquote("Phyto. (mg" ~ m^-3*")"),
       fill = "Group") +
  theme(
        legend.position = "right",
        legend.key.height = unit(0.5, "cm"),
        legend.title = element_blank(),
        text = element_text(size = 38), #35
        axis.text = element_text(color = "black"),
        axis.title.x = element_blank())

print(f_chem_22)
```
```{r}
f_chem_24 <- chem %>%
  ggplot() +
  geom_bar(aes(date, contribution, fill = fct_rev(group)),
           position = "stack", stat = "identity",
           alpha = 1, color = "black", size = 1) +
  ggsci::scale_fill_npg() +
  scale_x_date(limits = as.Date(c("2024-01-01", "2024-12-31")),
               expand = c(0, 0),
               date_breaks = "months", date_labels = "%b") +
  theme_bw() +
  labs(y = bquote("Phyto. (mg" ~ m^-3*")"),
       fill = "Group") +
  theme(
        legend.position = "right",
        legend.key.height = unit(0.5, "cm"),
        legend.title = element_blank(),
        text = element_text(size = 38), #35
        axis.text = element_text(color = "black"),
        axis.title.x = element_blank())

print(f_chem_24)
```
```{r}
f_22_panel <- ggarrange(f_wind_22, f_buoy_22, f_ctd_fl_22, f_chem_22,
                        ncol = 1)

ggsave(here("figures", "panel_kc10_2022_buoy_discrete.png"), f_22_panel,
        width = 16, height = 16, dpi = 300)

f_24_panel <- ggarrange(f_wind_24, f_buoy_24, f_ctd_fl_24, f_chem_24,
                        ncol = 1)

ggsave(here("figures", "panel_kc10_2024_buoy_discrete.png"), f_24_panel,
        width = 16, height = 16, dpi = 300)
```




