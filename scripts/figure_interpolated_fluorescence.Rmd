---
title: "R Notebook"
output: html_notebook
---

Some new interpolation tutorials to consider:
https://search.r-project.org/CRAN/refmans/rioja/html/interp.dataset.html
https://github.com/hdugan/NTLlakeloads

```{r}
#Upload packages
library(tidyverse)
library(here)
library(readxl)
library(patchwork)
library(lubridate)
library(MBA)
library(mgcv)
library(FNN)
library(zoo)
library(reshape2)
library(rioja)
library(egg)
library(palr)
library(ggsci)
library(gsw)
library(rsoi)
library(ggpubr)
library(akima)
library(metR)
```

```{r}
#Corrected CTD fluorescence data
ctd_fl <- read_csv(here("outputs",
                        "flu_qc_2025-11-25.csv"))

ctd <- read_csv(here("files", "ctd_kc10_fzh01_2025-08-09.csv"))

# #cm = chlorophylly march 
# cm <- read_csv(here("files", "chl_2022-03-09.csv")) 
# 
# #cs = chlorophyll september
# cs <- read_csv(here("files", "chl_2022-09-09.csv")) 

#Downloading discrete chlorophyll samples - This could be done using the API
cd <- read_csv(here("files", "chl_kc10_fzh01_2025-09-08.csv"))

fw <- read_csv(here("files", "Daily_flow_long_2014_2024_v2025_04_03.csv"))
```

```{r}
# Download MEI directly
mei_data <- download_mei()

```

```{r}
fw_tot <- fw %>% 
  filter(Watershed_group == "Q_Total") %>% 
  mutate(date = date(Date),
         year = year(date),
         month = month(date)) %>% 
  filter(year >= 2017)

```



```{r}
ctd_calc <- ctd %>% 
  mutate(date = date(`Measurement time`)) %>%
  filter(`Cast Direction Flag` == "d") %>% 
  # filter(is.na(`Fluorometry Chlorophyll flag`)) %>% 
  select(castpk = `Cast PK`,
         ctd_num =`CTD serial number`,
         date, m_time = `Measurement time`,
         station = Station,
         longitude = `Station Longitude`,
         latitude = `Station Latitude`,
         pres = `Pressure (dbar)`,
         sal = `Salinity (PSU)`,
         temp = `Temperature (deg C)`) %>%
  mutate(
    # Calculate absolute salinity from practical salinity
    sa = gsw_SA_from_SP(sal, pres, longitude, latitude),  # Adjust lat/lon for your study area
    # Calculate conservative temperature from in-situ temperature
    ct = gsw_CT_from_t(sa, temp, pres),
    # Calculate in-situ density (kg/m³)
    density = gsw_rho(sa, ct, pres),
    # Calculate potential density anomaly (sigma-theta, kg/m³ - 1000)
    sigma_theta = gsw_sigma0(sa, ct)
  )

daily_ctd <- ctd_calc %>%
  filter(!is.na(sal), !is.na(temp), !is.na(sigma_theta)) %>%  # Remove missing values
  
  # Step 1: Calculate daily means by depth
  group_by(date, pres) %>%
  summarise(
    sal_daily = mean(sal, na.rm = TRUE),
    temp_daily = mean(temp, na.rm = TRUE),
    sigma_theta_daily = mean(sigma_theta, na.rm = TRUE),
    .groups = 'drop'
  )
```

```{r}
ctd_fl_phys <- ctd_fl %>% 
  left_join(daily_ctd)

ctd_fl_phys <- ctd_fl_phys %>% 
  select(-f_calibrated) %>% 
  rename(f_corrected = f_final)
```

```{r}
# Option 3: Viridis-inspired but with dark blue start
fluor_palette_v3 <- colorRampPalette(c(
  "#08306b",  # Deep navy blue
  "#1f4e7a",  # Dark blue
  "#2e6b89",  # Medium blue
  "#4d8fc7",  # Bright blue
  "#2fb3d4",  # Vivid cyan-blue (bloom threshold)
  "#00a693",  # Bright teal
  "#4daf4a",  # Vibrant green
  "#8cc152",  # Lime green
  "#ffd23f",  # Bright yellow
  "#ff8c42",  # Vivid orange
  "#e74c3c"   # Bold red-orange
))

# Generate color vectors (50 colors for smooth gradients)
colors_v3 <- fluor_palette_v3(50)

# Function to create breaks that emphasize bloom threshold
create_fluor_breaks <- function(max_val = 50, bloom_threshold = 5) {
  # More breaks in the 0-10 range to capture bloom dynamics
  c(0, 1, 2, 3, 4, bloom_threshold, 7, 10, 15, 20, 30, 40, max_val)
}

ctd_fl_plot <- ctd_fl_phys %>%
  mutate(year = year(date),
         month = month(date)) %>% 
  filter(pres < 31) %>% 
  group_by(year, month, pres) %>% 
  summarise(f_corrected = median(f_corrected), .groups = "drop",
            temp = median(temp_daily),
            sal = median(sal_daily),
            sigma_theta = median(sigma_theta_daily)) %>%
  mutate(day = 15) %>% 
  unite(date, c(year, month, day), sep = "-") %>% 
  mutate(date = date(date)) %>% 
  drop_na()
```



```{r}
# Create regular grid for interpolation
date_seq <- seq(min(ctd_fl_plot$date), max(ctd_fl_plot$date), length.out = 300)
pres_seq <- seq(0, 30, length.out = 200)

# Interpolate fluorescence to regular grid
ctd_interp <- with(ctd_fl_plot, 
                   interp(x = as.numeric(date), y = pres, z = f_corrected,
                          xo = as.numeric(date_seq), yo = pres_seq))

# Interpolate temperature
temp_interp <- with(ctd_fl_plot, 
                    interp(x = as.numeric(date), y = pres, z = temp,
                           xo = as.numeric(date_seq), yo = pres_seq))

# Interpolate salinity
sal_interp <- with(ctd_fl_plot, 
                   interp(x = as.numeric(date), y = pres, z = sal,
                          xo = as.numeric(date_seq), yo = pres_seq))

# Interpolate sigma theta
sigma_interp <- with(ctd_fl_plot, 
                     interp(x = as.numeric(date), y = pres, z = sigma_theta,
                            xo = as.numeric(date_seq), yo = pres_seq))

# Convert to data frame
interp_df <- expand.grid(date = date_seq, pres = pres_seq) %>%
  mutate(
    f_npq = as.vector(ctd_interp$z),
    temp = as.vector(temp_interp$z),
    sal = as.vector(sal_interp$z),
    sigma_theta = as.vector(sigma_interp$z)
  ) %>%
  filter(pres > 0 & pres < 30)
```

```{r}
# Calculate integrated fluorescence (0-30m) by month
ctd_integrated <- ctd_fl %>%
  filter(pres <= 30) %>%  # 0-30m depth
  mutate(
    year_month = floor_date(date, "month"),
    year = year(date),
    month = month(date)
  ) %>%
  group_by(year_month, year, month) %>%
  # Integrate using trapezoidal rule (approximate)
  arrange(pres) %>%
  summarise(
    integrated_fl = sum(f_final * c(diff(pres), 0), na.rm = TRUE),  # Simple integration
    .groups = 'drop'
  ) %>%
  # Calculate monthly climatology and anomalies
  group_by(month) %>%
  mutate(
    monthly_mean = mean(integrated_fl, na.rm = TRUE),
    anomaly = integrated_fl - monthly_mean
  ) %>%
  ungroup()
```

```{r}
# Define common x-axis settings
common_x_breaks <- scales::date_breaks("1 year")
common_x_labels <- scales::date_format("%Y")
common_x_limits <- range(c(interp_df$date, ctd_integrated$year_month), na.rm = TRUE)
```


```{r}
p1 <- ggplot(interp_df, aes(x = date, y = pres, fill = f_npq)) +
  geom_raster() +
  # Add sigma_theta = 21 contour line
  geom_contour(aes(z = sigma_theta), breaks = 24, 
               color = "white", size = 1, alpha = 0.9) +
  geom_text_contour(aes(z = sigma_theta), breaks = 24,
                    color = "white", size = 4,
                    stroke = 0.3, stroke.color = "black",
                    skip = 10) +
  scale_x_date(expand = c(0, 0), 
               breaks = common_x_breaks,
               labels = common_x_labels,
               limits = common_x_limits) +
  scale_y_reverse(expand = c(0, 0),
                  breaks = seq(0, 50, by = 5),
                  labels = seq(0, 50, by = 5)) +
  scale_fill_gradientn(colors = colors_v3,
                       values = scales::rescale(c(0, 2, 5, 10, 20, 50)),
                       na.value = "white",
                       name = "Fluorescence (mg m⁻³)",
                       guide = guide_colorbar(
                         title.position = "right",
                         title.theme = element_text(angle = 270, hjust = 0.5)
                       )) +
  labs(x = "Date", y = "Depth (m)") +
  theme_bw() +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    text = element_text(color = "black", size = 25),
    legend.position = "right",
    legend.key.height = unit(1.5, "cm"),
    axis.text.x = element_blank(),
    axis.title.x = element_blank()
  )

print(p1)
```





```{r}
# Create bottom panel with line and bars
p2 <- ggplot(ctd_integrated, aes(x = year_month)) +
  # Anomaly bars
  geom_col(aes(y = anomaly, fill = anomaly > 0), 
           alpha = 0.7, width = 20) +  # width in days
  # Integrated fluorescence line
  geom_line(aes(y = integrated_fl), color = "black", size = 0.8) +
  geom_point(aes(y = integrated_fl), color = "black", size = 1.5) +
  scale_fill_manual(values = c("TRUE" = "red", "FALSE" = "blue")) +
  scale_x_date(expand = c(0, 0),
               breaks = common_x_breaks,
               labels = common_x_labels,
               limits = common_x_limits) +
  labs(x = "Date", 
       y = "Integrated Fluorescence\n(mg m⁻² × m)") +
  theme_bw() +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    axis.text = element_text(color = "black"),
    legend.position = "none",
    axis.title.x = element_blank(),
    text = element_text(color = "black", size = 25),
  )

print(p2)
```
```{r}
# Calculate density difference (30m - 1m) by date
density_diff_monthly <- ctd_calc %>%
  filter(pres %in% c(1, 30)) %>%
  filter(!is.na(sigma_theta)) %>%
  mutate(
    year_month = floor_date(date, "month"),
    year = year(date),
    month = month(date)
  ) %>%
  group_by(year_month, year, month, castpk) %>%
  # Check that we have both depths for each cast
  filter(all(c(1, 30) %in% pres), n() == 2) %>%
  summarise(
    # Calculate density difference (30m - 1m)
    sigma_diff = sigma_theta[pres == 30] - sigma_theta[pres == 1],
    .groups = 'drop'
  ) %>%
  # Calculate monthly mean density difference
  group_by(year_month, year, month) %>%
  summarise(
    monthly_sigma_diff = mean(sigma_diff, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  # Calculate monthly climatology and anomalies
  group_by(month) %>%
  mutate(
    monthly_mean = mean(monthly_sigma_diff, na.rm = TRUE),
    anomaly = monthly_sigma_diff - monthly_mean
  ) %>%
  ungroup()

# Create density difference plot
p_density <- ggplot(density_diff_monthly, aes(x = year_month)) +
  # Anomaly bars
  geom_col(aes(y = anomaly, fill = anomaly > 0), 
           alpha = 0.7, width = 20) +
  # Monthly density difference line
  geom_line(aes(y = monthly_sigma_diff), color = "black", size = 0.8) +
  geom_point(aes(y = monthly_sigma_diff), color = "black", size = 1.5) +
  scale_fill_manual(values = c("TRUE" = "red", "FALSE" = "blue")) +
  scale_x_date(expand = c(0, 0),
               breaks = common_x_breaks,
               labels = common_x_labels,
               limits = common_x_limits) +
  labs(x = "Date", 
       y = "Density Difference\n(30m - 1m, kg m⁻³)") +
  theme_bw() +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    axis.text = element_text(color = "black"),
    legend.position = "none",
    axis.title.x = element_blank(),
    text = element_text(color = "black", size = 25)
  )

print(p_density)
```


```{r}
# Combine panels
combined_plot <- p1 / p2   # Top panel twice as tall

print(combined_plot)

ggsave(here("figures", "panel_kc10_interp_2025-11-25.png"), combined_plot,
       width = 16, height = 8)
```
```{r}
# Calculate integrated fluorescence (0-30m) by station, date, and cast
ctd_integrated_by_cast <- ctd_fl %>%
  filter(pres <= 30) %>%  # 0-30m depth
  group_by(date, station, id) %>%
  # Integrate using trapezoidal rule for each cast
  arrange(pres) %>%
  summarise(
    integrated_fl = sum(f_final * c(diff(pres), 0), na.rm = TRUE),
    .groups = 'drop'
  )

# Calculate daily average by station
ctd_integrated_by_station <- ctd_integrated_by_cast %>%
  group_by(date, station) %>%
  summarise(
    integrated_fl = mean(integrated_fl, na.rm = TRUE),
    n_casts = n(),
    .groups = 'drop'
  )

# Find matching dates between KC10 and FZH01
matching_dates <- ctd_integrated_by_station %>%
  group_by(date) %>%
  filter(n_distinct(station) == 2,  # Both stations present
         all(c("KC10", "FZH01") %in% station)) %>%  # Specifically KC10 and FZH01
  ungroup()

# Pivot to wide format for comparison
comparison_data <- matching_dates %>%
  select(date, station, integrated_fl) %>%
  pivot_wider(names_from = station, 
              values_from = integrated_fl,
              names_prefix = "integrated_")

# Create scatter plot
ggplot(comparison_data, aes(x = integrated_KC10, y = integrated_FZH01)) +
  geom_point(size = 3, alpha = 0.7, color = "#2E86AB") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey50") +
  geom_smooth(method = "lm", se = TRUE, color = "#A23B72", fill = "#A23B72", alpha = 0.2) +
  labs(
    x = "KC10 Integrated Fluorescence (0-30m, mg/m²)",
    y = "FZH01 Integrated Fluorescence (0-30m, mg/m²)",
    title = "Comparison of Integrated Fluorescence: KC10 vs FZH01",
    subtitle = paste("n =", nrow(comparison_data), "matching dates (daily averages)")
  ) +
  theme_bw(base_size = 14) +
  theme(
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold")
  )

# Calculate correlation statistics
cor_test <- cor.test(comparison_data$integrated_KC10, 
                     comparison_data$integrated_FZH01)

cat("\nCorrelation statistics:\n")
cat("r =", round(cor_test$estimate, 3), "\n")
cat("p-value =", format.pval(cor_test$p.value, digits = 3), "\n")
```

```{r}
# Calculate correlation and linear model statistics
cor_test <- cor.test(comparison_data$integrated_KC10, 
                     comparison_data$integrated_FZH01)
lm_fit <- lm(integrated_FZH01 ~ integrated_KC10, data = comparison_data)
lm_summary <- summary(lm_fit)

# Create annotation text
stats_text <- paste0(
  "r = ", round(cor_test$estimate, 3), "\n",
  "p = ", format.pval(cor_test$p.value, digits = 3), "\n",
  "R² = ", round(lm_summary$r.squared, 3), "\n",
  "slope = ", round(coef(lm_fit)[2], 3), "\n",
  "n = ", nrow(comparison_data)
)

# Get axis limits for equal scaling
axis_limits <- c(
  min(c(comparison_data$integrated_KC10, comparison_data$integrated_FZH01), na.rm = TRUE),
  max(c(comparison_data$integrated_KC10, comparison_data$integrated_FZH01), na.rm = TRUE)
)

# Create scatter plot
ggplot(comparison_data, aes(x = integrated_KC10, y = integrated_FZH01)) +
  geom_point(size = 3, alpha = 0.7, color = "#2E86AB") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey50", linewidth = 0.8) +
  geom_smooth(method = "lm", se = TRUE, color = "#A23B72", fill = "#A23B72", alpha = 0.2) +
  annotate("text",
           x = axis_limits[1] + (axis_limits[2] - axis_limits[1]) * 0.05,
           y = axis_limits[2] - (axis_limits[2] - axis_limits[1]) * 0.05,
           label = stats_text,
           hjust = 0, vjust = 1, size = 4, fontface = "bold") +
  coord_fixed(ratio = 1, xlim = axis_limits, ylim = axis_limits) +
  labs(
    x = "KC10 Integrated Fluorescence (0-30m, mg/m²)",
    y = "FZH01 Integrated Fluorescence (0-30m, mg/m²)",
    title = "Comparison of Integrated Fluorescence: KC10 vs FZH01",
    subtitle = "Daily averages on matching dates",
    caption = "Dashed line = 1:1 relationship"
  ) +
  theme_bw(base_size = 14) +
  theme(
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold"),
    aspect.ratio = 1
  )

ggsave(here("figures", "integrated_comparison_station.png"),
       width = 9,
       height = 6)
```
```{r}
# Using scale_x_log10 and scale_y_log10
comparison_data_pos <- comparison_data %>%
  filter(integrated_KC10 > 0, integrated_FZH01 > 0)

# Stats still on log-transformed data
comparison_data_log <- comparison_data_pos %>%
  mutate(
    log_KC10 = log10(integrated_KC10),
    log_FZH01 = log10(integrated_FZH01)
  )

cor_test_log <- cor.test(comparison_data_log$log_KC10, 
                         comparison_data_log$log_FZH01)
lm_fit_log <- lm(log_FZH01 ~ log_KC10, data = comparison_data_log)
lm_summary_log <- summary(lm_fit_log)

stats_text_log <- paste0(
  "r = ", round(cor_test_log$estimate, 3), "\n",
  "p = ", format.pval(cor_test_log$p.value, digits = 3), "\n",
  "R² = ", round(lm_summary_log$r.squared, 3), "\n",
  "slope = ", round(coef(lm_fit_log)[2], 3), "\n",
  "n = ", nrow(comparison_data_log)
)

ggplot(comparison_data_pos, aes(x = integrated_KC10, y = integrated_FZH01)) +
  geom_point(size = 3, alpha = 0.7, color = "#2E86AB") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey50", linewidth = 0.8) +
  geom_smooth(method = "lm", se = TRUE, color = "#A23B72", fill = "#A23B72", alpha = 0.2) +
  annotate("text", 
           x = 2, y = 250,
           label = stats_text_log,
           hjust = 0, vjust = 1, size = 4, fontface = "bold") +
  scale_x_log10(name = "KC10 Integrated Fluorescence (0-30m, mg/m²)") +
  scale_y_log10(name = "FZH01 Integrated Fluorescence (0-30m, mg/m²)") +
  coord_fixed(ratio = 1) +
  labs(
    title = "Comparison of Integrated Fluorescence: KC10 vs FZH01",
    subtitle = "Log10 scale, daily averages on matching dates",
    caption = "Dashed line = 1:1 relationship"
  ) +
  theme_bw(base_size = 14) +
  theme(
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold")
  )

ggsave(here("figures", "integrated_comparison_station_log_scale.png"),
       width = 8,
       height = 8)
```
```{r}
# Calculate correlation and linear model statistics on log10-transformed data
comparison_data_log <- comparison_data %>%
  filter(integrated_KC10 > 0, integrated_FZH01 > 0) %>%  # Remove zeros for log transform
  mutate(
    log_KC10 = log10(integrated_KC10),
    log_FZH01 = log10(integrated_FZH01)
  )

cor_test_log <- cor.test(comparison_data_log$log_KC10, 
                         comparison_data_log$log_FZH01)
lm_fit_log <- lm(log_FZH01 ~ log_KC10, data = comparison_data_log)
lm_summary_log <- summary(lm_fit_log)

# Create annotation text
stats_text_log <- paste0(
  "r = ", round(cor_test_log$estimate, 3), "\n",
  "p = ", format.pval(cor_test_log$p.value, digits = 3), "\n",
  "R² = ", round(lm_summary_log$r.squared, 3), "\n",
  "slope = ", round(coef(lm_fit_log)[2], 3), "\n",
  "n = ", nrow(comparison_data_log)
)

# Get axis limits for equal scaling (in log space)
log_limits <- c(
  min(c(comparison_data_log$log_KC10, comparison_data_log$log_FZH01), na.rm = TRUE),
  max(c(comparison_data_log$log_KC10, comparison_data_log$log_FZH01), na.rm = TRUE)
)

# Create scatter plot
ggplot(comparison_data_log, aes(x = log_KC10, y = log_FZH01)) +
  geom_point(size = 3, alpha = 0.7, color = "#2E86AB") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey50", linewidth = 0.8) +
  geom_smooth(method = "lm", se = TRUE, color = "#A23B72", fill = "#A23B72", alpha = 0.2) +
  annotate("text", 
           x = log_limits[1] + (log_limits[2] - log_limits[1]) * 0.05,
           y = log_limits[2] - (log_limits[2] - log_limits[1]) * 0.05,
           label = stats_text_log,
           hjust = 0, vjust = 1, size = 4, fontface = "bold") +
  coord_fixed(ratio = 1, xlim = log_limits, ylim = log_limits) +
  labs(
    x = expression(log[10]~"KC10 Integrated Fluorescence (mg/m²)"),
    y = expression(log[10]~"FZH01 Integrated Fluorescence (mg/m²)"),
    title = "Comparison of Integrated Fluorescence: KC10 vs FZH01",
    subtitle = "Log10-transformed, daily averages on matching dates",
    caption = "Dashed line = 1:1 relationship"
  ) +
  theme_bw(base_size = 14) +
  theme(
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold")
  )

ggsave(here("figures", "integrated_comparison_station_log.png"),
       width = 8,
       height = 8)
```



```{r}
#Working with the discrete chlorophyll dataset

#Pulling out bulk data with appropriate flags and running a daily mean in case there are duplicates
#Allowing SVC and ADL as generally OK.
c_qc <- cd %>% 
  select(date, station = site_id, line_out_depth, filter_type, chla, chla_flag) %>% 
  filter(filter_type == "Bulk GF/F") %>% 
  filter(chla_flag == "AV" | chla_flag == "SVC" | chla_flag == "ADL" | is.na(chla_flag)) 

#Calculating a daily mean value in case of duplicates and setting the 0m sampling depth to 1m to match with the closest CTD fluorometer record
c_dm <- c_qc %>% 
  group_by(date, station, line_out_depth) %>% 
  summarise(chl_dm = mean(chla)) %>% 
  ungroup() %>% 
  mutate(pres = round(line_out_depth)) %>%
  drop_na() %>% 
  group_by(date, station) %>% 
  mutate(n_dep = n()) %>% 
  ungroup() %>% 
  filter(n_dep >= 3) %>% #This could be altered to > 3x points maybe?
  mutate(year = year(date)) %>% 
  mutate(pres = case_when(pres == 0 ~ 1,
                          TRUE ~ as.numeric(pres)))
```
```{r}
#working with the size-fractionated dataset to create a size-fractionated sum value where we are missing bulk samples

#Pulling out size-fractionated data
c_sf <- cd %>% 
  select(date, station = site_id, line_out_depth, filter_type, chla, chla_flag) %>% 
  filter(!filter_type == "Bulk GF/F") %>% 
  filter(chla_flag == "AV" | chla_flag == "SVC" | chla_flag == "ADL" | is.na(chla_flag))

#Calculating a daily mean value where there are three filters available to complete the set.
c_sf_dm <- c_sf %>% 
  filter(!is.na(chla)) %>%
  filter(chla > 0) %>% 
  group_by(date, station, line_out_depth, filter_type) %>% 
  summarise(avg_chla = mean(chla)) %>%
  ungroup() %>% 
  group_by(date, station, line_out_depth) %>% 
  mutate(n_filt = n()) %>% 
  ungroup() %>% 
  group_by(date, station, line_out_depth, filter_type) %>% 
  mutate(n_type = n()) %>% 
  ungroup() %>% 
  filter(n_filt == 3 & n_type == 1) %>% 
  group_by(date, station, line_out_depth) %>% 
  mutate(sum = sum(avg_chla)) %>% 
  ungroup() %>% 
  mutate(perc = avg_chla/sum) %>% 
  select(date, station, pres = line_out_depth, filter_type, avg_chla, sum, perc) %>% 
  mutate(filter_type2 = case_when(filter_type == "2um" ~ "3um",
                                  TRUE ~ as.character(filter_type)))

#Setting the 0m sampling depth to 1m
c_sum <- c_sf_dm %>% 
  distinct(sum, .keep_all = T) %>% 
  select(date, station, pres, sum) %>% 
  mutate(pres = case_when(pres == 0 ~ 1,
                          TRUE ~ as.numeric(pres)))

```
```{r}
#Joining the bulk and size-fractionated sum and then creating combined column where the size-fractionated value is used where there are NA's for the bulk.
c_join <- c_dm %>% 
  full_join(c_sum) %>% 
  mutate(chl_comb = case_when(is.na(chl_dm) ~ sum,
                              !is.na(chl_dm) ~ chl_dm)) %>% 
  select(date, station, pres, chl_dm, chl_comb) %>% 
  unite(id, c(date, station), sep = "-", remove = F)
```
```{r}
c_plot <- c_join %>% 
  filter(pres %in% c(1, 5, 10)) 

```

```{r}
# Prepare the chlorophyll data
c_monthly <- c_plot %>%
  mutate(
    year_month = floor_date(date, "month"),
    year = year(date),
    month = month(date),
    depth_label = paste0(pres, "m")  # Create depth labels
  ) %>%
  group_by(year_month, pres, depth_label, year, month) %>%
  summarise(
    monthly_chl = mean(chl_comb, na.rm = TRUE),  # Assuming your chl column name
    .groups = 'drop'
  ) %>%
  # Calculate monthly climatology and anomalies for each depth
  group_by(month, pres) %>%
  mutate(
    monthly_mean = mean(monthly_chl, na.rm = TRUE),
    anomaly = monthly_chl - monthly_mean
  ) %>%
  ungroup()
```



```{r}
# Create ordered factor for proper facet ordering
c_monthly <- c_monthly %>%
  mutate(
    depth_label = factor(paste0(pres, " m"), 
                        levels = c("1 m", "5 m", "10 m"))
  )

# Alternative: Separate anomaly plot by depth
ggplot(c_monthly, aes(x = year_month)) +
  # Anomaly bars
  geom_col(aes(y = anomaly, fill = anomaly > 0), 
           alpha = 0.7, width = 20) +
  # Monthly chlorophyll lines and points
  geom_line(aes(y = monthly_chl), color = "black", size = 1) +
  geom_point(aes(y = monthly_chl), color = "black", size = 2) +
  facet_wrap(~depth_label, ncol = 1,
             strip.position = "right") +
  scale_fill_manual(values = c("TRUE" = "red", "FALSE" = "blue")) +
  scale_x_date(expand = c(0, 0),
               breaks = scales::date_breaks("1 year"),
               labels = scales::date_format("%Y")) +
  labs(y = "Chlorophyll-a (mg m⁻³)") +  # Removed x = "Date"
  theme_bw() +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    text = element_text(color = "black", size = 25),
    axis.text = element_text(color = "black"),
    legend.position = "none",
    strip.background = element_rect(fill = "white", color = "black"),
    strip.text = element_text(size = 20, face = "bold"),
    axis.title.x = element_blank()  # Remove x-axis title
  )
```


```{r}
ggsave(here("figures", "panel_kc10_bottle_depth.png"),
       width = 16, height = 8)
```

```{r}
mei_data <- mei_data %>% 
  mutate(month = month(Date)) %>% 
  rename(year = Year)

test <- ctd_integrated %>% 
  left_join(mei_data) %>% 
  group_by(year) %>% 
  summarise(int_year = mean(integrated_fl),
            int_anom_year = mean(anomaly),
            mei_year = mean(MEI)) %>% 
  ungroup()

test %>% 
  filter(year < 2024) %>% 
  ggplot(aes(x = int_anom_year, y = mei_year, fill = as.factor(year))) +
  geom_point(pch = 21, size = 3)

test %>% 
  filter(year < 2024) %>% 
  ggplot(aes(x = int_anom_year, y = mei_year, fill = as.factor(year))) +
  geom_point(pch = 21, size = 3)
```

```{r}
# Annual data
annual_data <- ctd_integrated %>% 
  left_join(mei_data, by = c("year", "month")) %>% 
  group_by(year) %>% 
  summarise(
    integrated_fl = mean(integrated_fl, na.rm = TRUE),
    integrated_anom = mean(anomaly, na.rm = TRUE),
    mei_annual = mean(MEI, na.rm = TRUE),
    .groups = 'drop'
  ) %>% 
  filter(year < 2024) 

# Calculate correlations for custom labels
cor_fl <- cor.test(annual_data$integrated_fl, annual_data$mei_annual)
cor_anom <- cor.test(annual_data$integrated_anom, annual_data$mei_annual)

# Format p-values
format_p <- function(p) {
  if(p < 0.001) return("p < 0.001")
  else return(paste0("p = ", round(p, 3)))
}

cor_label_fl <- paste0("r = ", round(cor_fl$estimate, 2), 
                       ", ", format_p(cor_fl$p.value))
cor_label_anom <- paste0("r = ", round(cor_anom$estimate, 2), 
                         ", ", format_p(cor_anom$p.value))

# Define consistent theme with larger text
theme_custom <- theme_bw(base_size = 14) +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )

# Plot 1: Integrated fluorescence vs MEI
p1 <- annual_data %>% 
  ggplot(aes(x = integrated_fl, y = mei_annual)) +
  geom_smooth(method = "lm", se = TRUE, color = "gray40", 
              linewidth = 0.8, alpha = 0.3) +
  geom_point(aes(fill = as.factor(year)), 
             pch = 21, size = 5, color = "black", stroke = 1) +
  annotate("text", x = -Inf, y = Inf, label = cor_label_fl,
           hjust = -0.1, vjust = 1.5, size = 5) +
  scale_fill_viridis_d(name = "Year", option = "turbo") +
  labs(x = "Annual Integrated Fluorescence (mg m⁻²·m)",
       y = "Annual MEI",
       title = "Integrated Fluorescence vs MEI") +
  theme_custom +
  theme(legend.position = "none")

# Plot 2: Fluorescence anomaly vs MEI
p2 <- annual_data %>% 
  ggplot(aes(x = integrated_anom, y = mei_annual)) +
  geom_smooth(method = "lm", se = TRUE, color = "gray40", 
              linewidth = 0.8, alpha = 0.3) +
  geom_point(aes(fill = as.factor(year)), 
             pch = 21, size = 5, color = "black", stroke = 1) +
  annotate("text", x = -Inf, y = Inf, label = cor_label_anom,
           hjust = -0.1, vjust = 1.5, size = 5) +
  scale_fill_viridis_d(name = "Year", option = "turbo") +
  labs(x = "Annual Integrated Fluorescence Anomaly (mg m⁻²·m)",
       y = "Annual MEI",
       title = "Fluorescence Anomaly vs MEI") +
  theme_custom +
  theme(legend.position = "right")

# Plot 3: Time series of integrated fluorescence
# Color represents the actual fluorescence value
p3 <- annual_data %>% 
  ggplot(aes(x = year, y = integrated_fl)) +
  geom_line(color = "steelblue", linewidth = 1.2) +
  geom_point(aes(fill = integrated_fl), 
             pch = 21, size = 5, color = "black", stroke = 1) +
  scale_fill_gradient2(
    low = "#2166AC", mid = "white", high = "#B2182B",
    midpoint = mean(annual_data$integrated_fl),
    name = "Fluorescence\n(mg m⁻²·m)"
  ) +
  scale_x_continuous(breaks = 2012:2023) +
  labs(x = NULL,
       y = "Integrated Fluorescence\n(mg m⁻²·m)",
       title = "Annual Integrated Fluorescence") +
  theme_custom +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

# Plot 4: Time series of MEI
# Color represents ENSO phase (blue = La Niña, red = El Niño)
p4 <- annual_data %>% 
  ggplot(aes(x = year, y = mei_annual)) +
  geom_hline(yintercept = 0, linetype = "dashed", 
             color = "gray30", linewidth = 0.8) +
  geom_line(color = "darkorange", linewidth = 1.2) +
  geom_point(aes(fill = mei_annual), 
             pch = 21, size = 5, color = "black", stroke = 1) +
  scale_fill_gradient2(
    low = "#2166AC", mid = "white", high = "#B2182B",
    midpoint = 0,
    name = "MEI\n(ENSO phase)"
  ) +
  scale_x_continuous(breaks = 2012:2023) +
  labs(x = "Year",
       y = "Annual MEI",
       title = "Annual Multivariate ENSO Index") +
  theme_custom

# Combine plots
combined_plot <- (p1 | p2) / p3 / p4 +
  plot_layout(heights = c(1.2, 0.8, 0.8)) +
  plot_annotation(
    title = "Relationship between Integrated Fluorescence and ENSO (MEI)",
    subtitle = "KC10, Fitz-Hugh Channel, 2017-2023",
    theme = theme(
      plot.title = element_text(size = 18, face = "bold"),
      plot.subtitle = element_text(size = 14)
    )
  )

# Display
combined_plot

# Save at high resolution
ggsave(here("figures","fluorescence_mei_analysis_no_quench.png"), combined_plot,
       width = 14, height = 12, 
       dpi = 300)
```

```{r}
library(tidyverse)
library(patchwork)
library(metR)  # for geom_text_contour
library(here)

# Define common x-axis elements for 2017-2023 period
common_x_breaks <- seq(as.Date("2012-01-01"), as.Date("2024-01-01"), by = "1 year")
common_x_labels <- format(common_x_breaks, "%Y")
common_x_limits <- c(as.Date("2012-01-01"), as.Date("2023-12-31"))

# Define color palette for fluorescence
colors_v3 <- c("#08519c", "#3182bd", "#6baed6", "#9ecae1", 
               "#c6dbef", "#ffffcc", "#ffeda0", "#fed976", 
               "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026")

# Define consistent theme
theme_panels <- theme_bw() +
  theme(
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    text = element_text(color = "black", size = 25),
    axis.text = element_text(color = "black"),
    legend.key.height = unit(1.5, "cm")
  )

# Panel 1: Interpolated fluorescence with density contour
p1 <- ggplot(interp_df, aes(x = date, y = pres, fill = f_npq)) +
  geom_raster() +
  geom_contour(aes(z = sigma_theta), 
               breaks = 24, 
               color = "white", 
               linewidth = 1, 
               alpha = 0.9) +
  geom_text_contour(aes(z = sigma_theta), 
                    breaks = 24,
                    color = "white", 
                    size = 4,
                    stroke = 0.3, 
                    stroke.color = "black",
                    skip = 10) +
  scale_x_date(expand = c(0, 0), 
               breaks = common_x_breaks,
               labels = common_x_labels,
               limits = common_x_limits) +
  scale_y_reverse(expand = c(0, 0),
                  breaks = seq(0, 50, by = 10)) +
  scale_fill_gradientn(colors = colors_v3,
                       values = scales::rescale(c(0, 2, 5, 10, 20, 50)),
                       na.value = "white",
                       name = "Fluorescence\n(mg m⁻³)",
                       guide = guide_colorbar(
                         title.position = "right",
                         title.theme = element_text(angle = 270, hjust = 0.5)
                       )) +
  labs(x = NULL, y = "Depth (m)") +
  theme_panels +
  theme(
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "right"
  )

# Panel 2: Integrated fluorescence with anomaly bars
p2 <- ggplot(ctd_integrated, aes(x = year_month)) +
  geom_col(aes(y = anomaly, fill = anomaly > 0), 
           alpha = 0.7, 
           width = 20) +
  geom_line(aes(y = integrated_fl), 
            color = "black", 
            linewidth = 0.8) +
  geom_point(aes(y = integrated_fl), 
             color = "black", 
             size = 1.5) +
  scale_fill_manual(values = c("TRUE" = "#B2182B", "FALSE" = "#2166AC"),
                    guide = "none") +
  scale_x_date(expand = c(0, 0),
               breaks = common_x_breaks,
               labels = common_x_labels,
               limits = common_x_limits) +
  scale_y_continuous(breaks = seq(0, 400, by = 100)) +
  labs(x = NULL, 
       y = "Integrated Fluor.\n(mg m⁻² × m)") +
  theme_panels +
  theme(
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none"
  )

# Panel 3: Monthly MEI
# Prepare MEI data with date column and phase classification
mei_plot_data <- mei_data %>%
  mutate(
    plot_date = as.Date(Date),
    Phase = case_when(
      MEI >= 0.5 ~ "El Niño",
      MEI <= -0.5 ~ "La Niña",
      TRUE ~ "Neutral"
    ),
    Phase = factor(Phase, levels = c("El Niño", "Neutral", "La Niña"))
  ) %>%
  filter(plot_date >= as.Date("2012-01-01") & 
         plot_date <= as.Date("2023-12-31"))

p3 <- ggplot(mei_plot_data, aes(x = plot_date, y = MEI)) +
  geom_hline(yintercept = 0, 
             linetype = "dashed", 
             color = "gray30", 
             linewidth = 0.8) +
  geom_col(aes(fill = Phase), 
           width = 25,  # width in days
           alpha = 0.8) +
  geom_line(color = "black", 
            linewidth = 0.6) +
  scale_fill_manual(
    values = c("El Niño" = "#B2182B", 
               "La Niña" = "#2166AC", 
               "Neutral" = "gray70"),
    name = "ENSO Phase"
  ) +
  scale_x_date(expand = c(0, 0),
               breaks = common_x_breaks,
               labels = common_x_labels,
               limits = common_x_limits) +
  scale_y_continuous(breaks = seq(-2, 3, by = 1)) +
  labs(x = "Date", 
       y = "MEI") +
  theme_panels +
  theme(legend.position = "right")

# Combine all three panels
combined_plot <- p1 / p2 / p3 +
  plot_layout(heights = c(1.2, 0.8, 0.8))

# Display
print(combined_plot)

# Save
ggsave(here("figures", "panel_kc10_interp_int_mei_no_quench.png"), 
       combined_plot,
       width = 16, 
       height = 12,
       dpi = 300)
```
```{r}
library(tidyverse)
library(patchwork)
library(metR)  # for geom_text_contour
library(here)

# Define common x-axis elements for 2017-2023 period
common_x_breaks <- seq(as.Date("2012-01-01"), as.Date("2024-01-01"), by = "1 year")
common_x_labels <- format(common_x_breaks, "%Y")
common_x_limits <- c(as.Date("2012-01-01"), as.Date("2023-12-31"))

# Define color palette for fluorescence
colors_v3 <- c("#08519c", "#3182bd", "#6baed6", "#9ecae1", 
               "#c6dbef", "#ffffcc", "#ffeda0", "#fed976", 
               "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026")

# Define consistent theme
theme_panels <- theme_bw() +
  theme(
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    text = element_text(color = "black", size = 25),
    axis.text = element_text(color = "black"),
    legend.key.height = unit(1.5, "cm")
  )

# Calculate monthly discharge and anomalies
fw_monthly <- fw_tot %>%
  mutate(year_month = floor_date(date, "month")) %>%
  group_by(year_month) %>%
  summarise(
    Q_monthly = mean(Q, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    month = month(year_month),
    # Calculate climatological mean for each month
    Q_clim = mean(Q_monthly[month(year_month) == month], na.rm = TRUE),
    # Calculate anomaly
    Q_anomaly = Q_monthly - Q_clim
  ) %>%
  ungroup()

# Panel 1: Interpolated fluorescence with density contour
p1 <- ggplot(interp_df, aes(x = date, y = pres, fill = f_npq)) +
  geom_raster() +
  geom_contour(aes(z = sigma_theta), 
               breaks = 24, 
               color = "white", 
               linewidth = 1, 
               alpha = 0.9) +
  geom_text_contour(aes(z = sigma_theta), 
                    breaks = 24,
                    color = "white", 
                    size = 4,
                    stroke = 0.3, 
                    stroke.color = "black",
                    skip = 10) +
  scale_x_date(expand = c(0, 0), 
               breaks = common_x_breaks,
               labels = common_x_labels,
               limits = common_x_limits) +
  scale_y_reverse(expand = c(0, 0),
                  breaks = seq(0, 50, by = 10)) +
  scale_fill_gradientn(colors = colors_v3,
                       values = scales::rescale(c(0, 2, 5, 10, 20, 50)),
                       na.value = "white",
                       name = "Fluorescence\n(mg m⁻³)",
                       guide = guide_colorbar(
                         title.position = "right",
                         title.theme = element_text(angle = 270, hjust = 0.5)
                       )) +
  labs(x = NULL, y = "Depth (m)") +
  theme_panels +
  theme(
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "right"
  )

# Panel 2: Integrated fluorescence with anomaly bars
p2 <- ggplot(ctd_integrated, aes(x = year_month)) +
  geom_col(aes(y = anomaly, fill = anomaly > 0), 
           alpha = 0.7, 
           width = 20) +
  geom_line(aes(y = integrated_fl), 
            color = "black", 
            linewidth = 0.8) +
  geom_point(aes(y = integrated_fl), 
             color = "black", 
             size = 1.5) +
  scale_fill_manual(values = c("TRUE" = "#B2182B", "FALSE" = "#2166AC"),
                    guide = "none") +
  scale_x_date(expand = c(0, 0),
               breaks = common_x_breaks,
               labels = common_x_labels,
               limits = common_x_limits) +
  scale_y_continuous(breaks = seq(0, 400, by = 100)) +
  labs(x = NULL, 
       y = "Integrated Fluor.\n(mg m⁻² × m)") +
  theme_panels +
  theme(
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none"
  )

# Panel 3: Monthly discharge with anomaly bars
p3 <- ggplot(fw_monthly, aes(x = year_month)) +
  geom_col(aes(y = Q_anomaly, fill = Q_anomaly > 0), 
           alpha = 0.7, 
           width = 20) +
  geom_line(aes(y = Q_monthly), 
            color = "black", 
            linewidth = 0.8) +
  geom_point(aes(y = Q_monthly), 
             color = "black", 
             size = 1.5) +
  scale_fill_manual(values = c("TRUE" = "#B2182B", "FALSE" = "#2166AC"),
                    guide = "none") +
  scale_x_date(expand = c(0, 0),
               breaks = common_x_breaks,
               labels = common_x_labels,
               limits = common_x_limits) +
  labs(x = NULL, 
       y = "Discharge\n(m³ s⁻¹)") +
  theme_panels +
  theme(
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none"
  )

# Panel 4: Monthly MEI
mei_plot_data <- mei_data %>%
  mutate(
    plot_date = as.Date(Date),
    Phase = case_when(
      MEI >= 0.5 ~ "El Niño",
      MEI <= -0.5 ~ "La Niña",
      TRUE ~ "Neutral"
    ),
    Phase = factor(Phase, levels = c("El Niño", "Neutral", "La Niña"))
  ) %>%
  filter(plot_date >= as.Date("2012-01-01") & 
         plot_date <= as.Date("2023-12-31"))

p4 <- ggplot(mei_plot_data, aes(x = plot_date, y = MEI)) +
  geom_hline(yintercept = 0, 
             linetype = "dashed", 
             color = "gray30", 
             linewidth = 0.8) +
  geom_col(aes(fill = Phase), 
           width = 25,
           alpha = 0.8) +
  geom_line(color = "black", 
            linewidth = 0.6) +
  scale_fill_manual(
    values = c("El Niño" = "#B2182B", 
               "La Niña" = "#2166AC", 
               "Neutral" = "gray70"),
    name = "ENSO Phase"
  ) +
  scale_x_date(expand = c(0, 0),
               breaks = common_x_breaks,
               labels = common_x_labels,
               limits = common_x_limits) +
  scale_y_continuous(breaks = seq(-2, 3, by = 1)) +
  labs(x = "Date", 
       y = "MEI") +
  theme_panels +
  theme(legend.position = "right")

# Combine all four panels
combined_plot <- p1 / p2 / p3 / p4 +
  plot_layout(heights = c(1.2, 0.8, 0.8, 0.8))

# Display
print(combined_plot)

# Save
ggsave(here("figures", "panel_kc10_interp_int_fw-total_mei_no_quench.png"), 
       combined_plot,
       width = 16, 
       height = 14,
       dpi = 300)
```

```{r}
library(tidyverse)
library(patchwork)
library(ggpubr)

# Calculate annual discharge
annual_discharge <- fw_tot %>%
  group_by(year) %>%
  summarise(
    Q_annual = mean(Q, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  filter(year > 2012 & year < 2024)

# Join with existing annual data
annual_data_full <- annual_data %>%
  left_join(annual_discharge, by = "year") %>% 
  filter(!year == 2022)

# Calculate correlations
cor_mei_q <- cor.test(annual_data_full$mei_annual, annual_data_full$Q_annual)
cor_fluor_q <- cor.test(annual_data_full$integrated_anom, annual_data_full$Q_annual)

# Format p-values
format_p <- function(p) {
  if(p < 0.001) return("p < 0.001")
  else return(paste0("p = ", round(p, 3)))
}

cor_label_mei_q <- paste0("r = ", round(cor_mei_q$estimate, 2), 
                          ", ", format_p(cor_mei_q$p.value))
cor_label_fluor_q <- paste0("r = ", round(cor_fluor_q$estimate, 2), 
                            ", ", format_p(cor_fluor_q$p.value))

# Define consistent theme
theme_custom <- theme_bw(base_size = 14) +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )

# Plot 1: MEI vs Discharge
p1 <- annual_data_full %>% 
  ggplot(aes(x = Q_annual, y = mei_annual)) +
  geom_smooth(method = "lm", se = TRUE, color = "gray40", 
              linewidth = 0.8, alpha = 0.3) +
  geom_point(aes(fill = as.factor(year)), 
             pch = 21, size = 5, color = "black", stroke = 1) +
  annotate("text", x = -Inf, y = Inf, label = cor_label_mei_q,
           hjust = -0.1, vjust = 1.5, size = 5) +
  scale_fill_viridis_d(name = "Year", option = "turbo") +
  labs(x = "Annual Mean Discharge (m³ s⁻¹)",
       y = "Annual MEI",
       title = "MEI vs Freshwater Discharge") +
  theme_custom +
  theme(legend.position = "none")

# Plot 2: Fluorescence anomaly vs Discharge
p2 <- annual_data_full %>%
  filter(!year == 2022) %>% 
  ggplot(aes(x = Q_annual, y = integrated_anom)) +
  geom_smooth(method = "lm", se = TRUE, color = "gray40", 
              linewidth = 0.8, alpha = 0.3) +
  geom_point(aes(fill = as.factor(year)), 
             pch = 21, size = 5, color = "black", stroke = 1) +
  annotate("text", x = -Inf, y = Inf, label = cor_label_fluor_q,
           hjust = -0.1, vjust = 1.5, size = 5) +
  scale_fill_viridis_d(name = "Year", option = "turbo") +
  labs(x = "Annual Mean Discharge (m³ s⁻¹)",
       y = "Annual Integrated Fluorescence Anomaly (mg m⁻²·m)",
       title = "Fluorescence Anomaly vs Freshwater Discharge") +
  theme_custom +
  theme(legend.position = "right")

# Combine plots
discharge_plot <- (p1 | p2) +
  plot_annotation(
    title = "Relationship between Freshwater Discharge and Climate/Productivity",
    subtitle = "KC10, Fitz-Hugh Channel, 2017-2023",
    theme = theme(
      plot.title = element_text(size = 18, face = "bold"),
      plot.subtitle = element_text(size = 14)
    )
  )

# Display
discharge_plot

# Save
ggsave(here("figures", "discharge_relationships_no_quench.png"), 
       discharge_plot,
       width = 14, 
       height = 6, 
       dpi = 300)

# Optional: Print summary statistics
cat("\nCorrelation Summary:\n")
cat("MEI vs Discharge: r =", round(cor_mei_q$estimate, 3), 
    ", p =", round(cor_mei_q$p.value, 3), "\n")
cat("Fluorescence Anomaly vs Discharge: r =", round(cor_fluor_q$estimate, 3), 
    ", p =", round(cor_fluor_q$p.value, 3), "\n")
```

```{r}
# Calculate seasonal MEI (e.g., winter: DJF, spring: MAM, summer: JJA, fall: SON)
seasonal_data <- ctd_integrated %>% 
  left_join(mei_data, by = c("year", "month")) %>% 
  mutate(
    season = case_when(
      month %in% c(12, 1, 2) ~ "Winter",
      month %in% 3:5 ~ "Spring",
      month %in% 6:8 ~ "Summer",
      month %in% 9:11 ~ "Fall"
    )
  ) %>%
  group_by(year, season) %>%
  summarise(
    integrated_fl = mean(integrated_fl, na.rm = TRUE),
    integrated_anom = mean(anomaly, na.rm = TRUE),
    mei_seasonal = mean(MEI, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  filter(year > 2012 & year < 2024)

# Focus on growing season (e.g., Spring-Summer)
growing_season <- seasonal_data %>%
  filter(season %in% c("Spring", "Summer")) %>%
  group_by(year) %>%
  summarise(
    integrated_fl = mean(integrated_fl, na.rm = TRUE),
    integrated_anom = mean(integrated_anom, na.rm = TRUE),
    mei_growing = mean(mei_seasonal, na.rm = TRUE),
    .groups = 'drop'
  )

# Correlations for growing season
cor_growing <- cor.test(growing_season$integrated_anom, growing_season$mei_growing)
print(paste("Growing season correlation: r =", round(cor_growing$estimate, 3), 
            "p =", round(cor_growing$p.value, 3)))
```
```{r}
growing_season %>% 
  ggplot(aes(x = mei_growing, y = integrated_fl, color = as.factor(year))) +
  geom_point()
```

